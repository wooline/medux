{"version":3,"sources":["../../src/routePlanA.ts"],"names":["compilePath","compileToPath","matchPath","getSearch","searchOrHash","key","length","reg","RegExp","str","split","ISO_DATE_FORMAT","searchParse","search","undefined","JSON","parse","unescape","prop","value","test","Date","searchStringify","searchData","stringify","escape","pathnameParse","pathname","routeConfig","path","args","rule","hasOwnProperty","match","item","viewName","pathConfig","push","moduleName","url","params","Object","keys","replace","compileConfig","viewToRule","ruleToKeys","reduce","prev","cur","name","buildLocationToRoute","locationToRoute","location","paths","views","hashParams","hash","moduleParams","forEach","routeToLocation","routeData","urls","toPath","hashData","data","indexOf","join"],"mappings":"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","sourcesContent":["import {BrowserLocation, TransformRoute} from './index';\nimport {DisplayViews, RouteData} from '@medux/core/types/export';\nimport {compilePath, compileToPath, matchPath} from './matchPath';\n\nexport interface RouteConfig {\n  [path: string]: string | [string, RouteConfig];\n}\n\nfunction getSearch(searchOrHash: string, key: string): string {\n  if (searchOrHash.length < 4) {\n    return '';\n  }\n  const reg = new RegExp(`[&?]${key}=`);\n  const str = ('#' + searchOrHash).split(reg)[1];\n  if (!str) {\n    return '';\n  }\n  return str.split('&')[0];\n}\n\nconst ISO_DATE_FORMAT = /^\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d(\\.\\d+)?(Z|[+-][01]\\d:[0-5]\\d)$/;\n\n/*\n  将字符串变成 Data，因为 JSON 中没有 Date 类型，所以用正则表达式匹配自动转换\n*/\nfunction searchParse(search: string, key: string = 'q'): undefined | {[moduleName: string]: {[key: string]: any}} {\n  search = getSearch(search, key);\n  if (!search) {\n    return undefined;\n  }\n  return JSON.parse(unescape(search), (prop: any, value: any) => {\n    if (typeof value === 'string' && ISO_DATE_FORMAT.test(value)) {\n      return new Date(value);\n    }\n    return value;\n  });\n}\n\nfunction searchStringify(searchData: any, key: string = 'q'): string {\n  if (!searchData) {\n    return '';\n  }\n  const str = JSON.stringify(searchData);\n  if (!str || str === '{}') {\n    return '';\n  }\n  return `${key}=${escape(str)}`;\n}\nfunction pathnameParse(pathname: string, routeConfig: RouteConfig, path: string[], args: {[moduleName: string]: {[key: string]: any}}) {\n  for (const rule in routeConfig) {\n    if (routeConfig.hasOwnProperty(rule)) {\n      const match = matchPath(pathname, rule);\n      if (match) {\n        const item = routeConfig[rule];\n        const [viewName, pathConfig] = typeof item === 'string' ? [item, null] : item;\n        path.push(viewName);\n        const moduleName = viewName.split('.')[0];\n        const {url, params} = match;\n        if (params && Object.keys(params).length > 0) {\n          args[moduleName] = {...args[moduleName], ...params};\n        }\n        if (pathConfig) {\n          pathnameParse(pathname.replace(url, ''), pathConfig, path, args);\n        }\n        return;\n      }\n    }\n  }\n}\n\nfunction compileConfig(routeConfig: RouteConfig, viewToRule: {[viewName: string]: string} = {}, ruleToKeys: {[rule: string]: (string | number)[]} = {}) {\n  for (const rule in routeConfig) {\n    if (routeConfig.hasOwnProperty(rule)) {\n      if (!ruleToKeys[rule]) {\n        const {keys} = compilePath(rule);\n        ruleToKeys[rule] = keys.reduce((prev: (string | number)[], cur) => {\n          prev.push(cur.name);\n          return prev;\n        }, []);\n      }\n      const item = routeConfig[rule];\n      const [viewName, pathConfig] = typeof item === 'string' ? [item, null] : item;\n      viewToRule[viewName] = rule;\n      if (pathConfig) {\n        compileConfig(pathConfig, viewToRule, ruleToKeys);\n      }\n    }\n  }\n  return {viewToRule, ruleToKeys};\n}\n\nexport function buildLocationToRoute(routeConfig: RouteConfig): TransformRoute {\n  const {viewToRule, ruleToKeys} = compileConfig(routeConfig);\n  const locationToRoute: (location: BrowserLocation) => RouteData = location => {\n    const paths: string[] = [];\n    const params: {[moduleName: string]: {[key: string]: any}} = searchParse(location.search) || {};\n    pathnameParse(location.pathname, routeConfig, paths, params);\n    const views: DisplayViews = paths.reduce((prev: DisplayViews, cur) => {\n      const [moduleName, viewName] = cur.split('.');\n      if (viewName) {\n        if (!prev[moduleName]) {\n          prev[moduleName] = {};\n        }\n        prev[moduleName][viewName] = true;\n      }\n      return prev;\n    }, {});\n    const hashParams: {[moduleName: string]: {[key: string]: any}} = searchParse(location.hash) || {};\n    for (const moduleName in hashParams) {\n      if (hashParams.hasOwnProperty(moduleName)) {\n        const moduleParams = hashParams[moduleName];\n        Object.keys(moduleParams).forEach(key => {\n          params[moduleName][key] = moduleParams[key];\n        });\n      }\n    }\n    return {paths, params, views};\n  };\n  const routeToLocation: (routeData: RouteData) => BrowserLocation = routeData => {\n    const {paths, params} = routeData;\n    const urls: string[] = [];\n    const args: {[moduleName: string]: {[key: string]: any}} = {};\n    for (const moduleName in params) {\n      if (params.hasOwnProperty(moduleName)) {\n        args[moduleName] = {...params[moduleName]};\n      }\n    }\n    for (const viewName of paths) {\n      const rule = viewToRule[viewName];\n      const moduleName = viewName.split('.')[0];\n      const toPath = compileToPath(rule);\n      const url = toPath(params[moduleName]);\n      urls.push(url);\n      const keys = ruleToKeys[rule] || [];\n      keys.forEach(key => {\n        delete args[moduleName][key];\n      });\n    }\n    const searchData = {};\n    const hashData = {};\n    for (const moduleName in args) {\n      if (args.hasOwnProperty(moduleName)) {\n        const data = args[moduleName];\n        const keys = Object.keys(data);\n        if (keys.length > 0) {\n          keys.forEach(key => {\n            if (key.indexOf('_') === 0) {\n              if (!hashData[moduleName]) {\n                hashData[moduleName] = {};\n              }\n              hashData[moduleName][key] = data[key];\n            } else {\n              if (!searchData[moduleName]) {\n                searchData[moduleName] = {};\n              }\n              searchData[moduleName][key] = data[key];\n            }\n          });\n        }\n      }\n    }\n    return {\n      pathname: urls.join(''),\n      search: searchStringify(searchData),\n      hash: searchStringify(hashData),\n    };\n  };\n  return {\n    locationToRoute,\n    routeToLocation,\n  };\n}\n"],"file":"routePlanA.js"}