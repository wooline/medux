{"version":3,"sources":["../../src/index.tsx"],"names":["React","useState","useEffect","ReactDOM","renderToNodeStream","renderToString","Provider","createBrowserHistory","createMemoryHistory","withRouter","ConnectedRouter","connectRouter","routerMiddleware","renderApp","renderSSR","getView","isPromiseView","viewWillMount","viewWillUnmount","isServer","getClientStore","buildApp","moduleGetter","appModuleName","storeOptions","container","history","reducers","router","Error","state","action","routerData","routerParser","middlewares","unshift","store","appModel","appViews","ssrInitStoreKey","WithRouter","Main","app","render","window","hydrate","document","getElementById","buildSSR","initialEntries","renderToStream","data","getState","html","loadView","moduleName","viewName","loadingComponent","props","moduleViewResult","then","view","setComponent","Component","exportView","ComponentView","model","modelReady","setModelReady"],"mappings":"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","sourcesContent":["import React, {ReactElement, ComponentType, useState, useEffect} from 'react';\nimport ReactDOM from 'react-dom';\nimport {renderToNodeStream, renderToString} from 'react-dom/server';\nimport {Provider} from 'react-redux';\nimport {createBrowserHistory} from 'history';\nimport createMemoryHistory from 'history/createMemoryHistory';\nimport {withRouter} from 'react-router-dom';\nimport {ConnectedRouter, connectRouter, routerMiddleware} from 'connected-react-router';\nimport {renderApp, renderSSR, getView, isPromiseView, viewWillMount, viewWillUnmount, isServer, getClientStore} from '@medux/core';\nimport {ModuleGetter, StoreOptions, LoadView, ExportView} from '@medux/core/types/export';\n\nexport type RouterParser<T = any> = (nextRouter: T, prevRouter?: T) => T;\n\nexport function buildApp<M extends ModuleGetter, A extends Extract<keyof M, string>>(\n  moduleGetter: M,\n  appModuleName: A,\n  storeOptions: StoreOptions & {routerParser?: RouterParser} = {},\n  container: string | Element | ((component: ReactElement<any>) => void) = 'root'\n): Promise<void> {\n  const history = createBrowserHistory();\n  storeOptions.reducers = storeOptions.reducers || {};\n  if (storeOptions.reducers && storeOptions.reducers.router) {\n    throw new Error(\"the reducer name 'router' is not allowed\");\n  }\n  const router = connectRouter(history);\n  storeOptions.reducers.router = (state, action) => {\n    const routerData = router(state.router, action as any);\n    if (storeOptions.routerParser && state.router !== routerData) {\n      state.router = storeOptions.routerParser(routerData, state.router);\n    } else {\n      state.router = routerData;\n    }\n  };\n  storeOptions.middlewares = storeOptions.middlewares || [];\n  storeOptions.middlewares.unshift(routerMiddleware(history));\n\n  return renderApp(\n    (\n      store,\n      appModel,\n      appViews: {\n        [key: string]: React.ComponentType<any>;\n      },\n      ssrInitStoreKey\n    ) => {\n      const WithRouter = withRouter(appViews.Main);\n      const app = (\n        <Provider store={store}>\n          <ConnectedRouter history={history}>\n            <WithRouter />\n          </ConnectedRouter>\n        </Provider>\n      );\n      if (typeof container === 'function') {\n        container(app);\n      } else {\n        const render = window[ssrInitStoreKey] ? ReactDOM.hydrate : ReactDOM.render;\n        render(app, typeof container === 'string' ? document.getElementById(container) : container);\n      }\n    },\n    moduleGetter,\n    appModuleName,\n    storeOptions\n  );\n}\n\nexport function buildSSR<M extends ModuleGetter, A extends Extract<keyof M, string>>(\n  moduleGetter: M,\n  appModuleName: A,\n  initialEntries: string[],\n  storeOptions: StoreOptions & {routerParser?: RouterParser} = {},\n  renderToStream: boolean = false\n): Promise<{html: string | ReadableStream; data: any; ssrInitStoreKey: string}> {\n  const history = createMemoryHistory({initialEntries});\n  storeOptions.reducers = storeOptions.reducers || {};\n  if (storeOptions.reducers && storeOptions.reducers.router) {\n    throw new Error(\"the reducer name 'router' is not allowed\");\n  }\n  const router = connectRouter(history);\n  storeOptions.reducers.router = (state, action) => {\n    const routerData = router(state.router, action as any);\n    if (storeOptions.routerParser && state.router !== routerData) {\n      state.router = storeOptions.routerParser(routerData, state.router);\n    } else {\n      state.router = routerData;\n    }\n  };\n  storeOptions.middlewares = storeOptions.middlewares || [];\n  storeOptions.middlewares.unshift(routerMiddleware(history));\n  const render = renderToStream ? renderToNodeStream : renderToString;\n  return renderSSR(\n    (\n      store,\n      appModel,\n      appViews: {\n        [key: string]: React.ComponentType;\n      },\n      ssrInitStoreKey\n    ) => {\n      const data = store.getState();\n      return {\n        ssrInitStoreKey,\n        data,\n        html: render(\n          <Provider store={store}>\n            <ConnectedRouter history={history}>\n              <appViews.Main />\n            </ConnectedRouter>\n          </Provider>\n        ),\n      };\n    },\n    moduleGetter,\n    appModuleName,\n    storeOptions\n  );\n}\n\nexport const loadView: LoadView = (moduleGetter, moduleName, viewName, loadingComponent: React.ReactNode = null) => {\n  return function Loading(props: any) {\n    const [Component, setComponent] = useState<ComponentType | null>(() => {\n      const moduleViewResult = getView(moduleGetter[moduleName], viewName);\n      if (isPromiseView<ComponentType>(moduleViewResult)) {\n        moduleViewResult.then(view => {\n          setComponent(view);\n        });\n        return null;\n      } else {\n        return moduleViewResult;\n      }\n    });\n    return Component ? <Component {...props} /> : loadingComponent;\n  } as any;\n};\nexport const exportView: ExportView<ComponentType> = (ComponentView, model, viewName) => {\n  if (isServer()) {\n    return ComponentView;\n  } else {\n    return function View(props) {\n      const [modelReady, setModelReady] = useState(() => {\n        const state = getClientStore().getState();\n        const moduleName = model.moduleName;\n        model(getClientStore()).then(() => {\n          if (!modelReady) {\n            setModelReady(true);\n          }\n        });\n        return !!state[moduleName];\n      });\n      useEffect(() => {\n        viewWillMount(model.moduleName, viewName);\n        return () => {\n          viewWillUnmount(model.moduleName, viewName);\n        };\n      }, []);\n      return modelReady ? <ComponentView {...props} /> : null;\n    };\n  }\n};\n"],"file":"index.js"}