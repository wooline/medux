"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("@babel/runtime/helpers/assertThisInitialized"));require("@babel/runtime/helpers/possibleConstructorReturn"),require("@babel/runtime/helpers/getPrototypeOf");var r,n=e(require("@babel/runtime/helpers/inheritsLoose")),o=e(require("@babel/runtime/helpers/defineProperty")),i=require("redux"),a=e(require("@babel/runtime/regenerator")),u=e(require("@babel/runtime/helpers/asyncToGenerator")),s=e(require("@babel/runtime/helpers/decorate"));(r=exports.LoadingState||(exports.LoadingState={})).Start="Start",r.Stop="Stop",r.Depth="Depth";var c=function(){function e(e,t,r){void 0===r&&(r=!1),this.name=e,this.data=t,this.bubbling=r,o(this,"target",null),o(this,"currentTarget",null)}var t=e.prototype;return t.setTarget=function(e){this.target=e},t.setCurrentTarget=function(e){this.currentTarget=e},e}(),d=function(e){function r(r){var n;return(n=e.call(this)||this).deferSecond=r,o(t(n),"list",[]),o(t(n),"ctimer",null),n}n(r,e);var i=r.prototype;return i.addItem=function(e,t){var r=this;return void 0===t&&(t=""),this.list.some((function(t){return t.promise===e}))||(this.list.push({promise:e,note:t}),e.then((function(){return r.completeItem(e)}),(function(){return r.completeItem(e)})),1===this.list.length&&(this.dispatch(new c("TaskCountEvent",exports.LoadingState.Start)),this.ctimer=setTimeout((function(){r.ctimer=null,r.list.length>0&&r.dispatch(new c("TaskCountEvent",exports.LoadingState.Depth))}),1e3*this.deferSecond))),e},i.completeItem=function(e){var t=this.list.findIndex((function(t){return t.promise===e}));return t>-1&&(this.list.splice(t,1),0===this.list.length&&(this.ctimer&&(clearTimeout(this.ctimer),this.ctimer=null),this.dispatch(new c("TaskCountEvent",exports.LoadingState.Stop)))),this},r}(function(){function e(e){this.parent=e,o(this,"storeHandlers",{})}var t=e.prototype;return t.addListener=function(e,t){var r=this.storeHandlers[e];return r||(this.storeHandlers[e]=r=[]),r.push(t),this},t.removeListener=function(e,t){var r=this;if(e){var n=this.storeHandlers;if(n.propertyIsEnumerable(e)){var o=n[e];if(t){var i=o.indexOf(t);i>-1&&o.splice(i,1),0===o.length&&delete n[e]}else delete n[e]}}else Object.keys(this.storeHandlers).forEach((function(e){delete r.storeHandlers[e]}));return this},t.dispatch=function(e){e.target||e.setTarget(this),e.setCurrentTarget(this);var t=this.storeHandlers[e.name];if(t)for(var r=0,n=t.length;r<n;r++)t[r](e);return this.parent&&e.bubbling&&this.parent.dispatch(e),this},t.setParent=function(e){return this.parent=e,this},e}()),f={},l=2;function p(e,t,r){if(void 0===t&&(t=v.appModuleName),void 0===r&&(r="global"),v.isServer)return e;var n=t+h.NSP+r;return f[n]||(f[n]=new d(l),f[n].addListener("TaskCountEvent",(function(e){var n=v.clientStore;if(n){var o,i=(0,v.actionCreatorMap[t][_.MLoading])(((o={})[r]=e.data,o));n.dispatch(i)}}))),f[n].addItem(e),e}var h={NSP:"/",VSP:".",MSP:","};var v={isServer:"undefined"!=typeof global&&"undefined"==typeof window,isDev:"production"!==process.env.NODE_ENV,actionCreatorMap:null,clientStore:null,appModuleName:null,moduleGetter:null},_={MLoading:"Loading",MInit:"Init",MRouteParams:"RouteParams",Error:"medux"+h.NSP+"Error",RouteChange:"medux"+h.NSP+"RouteChange"},m=v.isServer?void 0:"undefined"==typeof window?global:window;function S(e){return"object"==typeof e&&"function"==typeof e.then}function y(e,t,r){t||r||(t=e.key,r=e.descriptor);var n=r.value;return n.__actionName__=t,n.__isReducer__=!0,r.enumerable=!0,e.descriptor===r?e:r}function g(e){return"object"!=typeof e||void 0===e.meduxProcessed?void 0:!!e.meduxProcessed}function b(e,t,r,n){if(n[e]||(n[e]={}),n[e][r])throw new Error("Action duplicate or conflict : "+e+".");n[e][r]=t}function x(e,t){var r=v.actionCreatorMap[e];r[t]||(r[t]=function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return{type:e+h.NSP+t,payload:n}})}function k(e){return{type:_.Error,payload:[e]}}function P(e){return{type:_.RouteChange,payload:[e]}}function M(e,t){return{type:""+e+h.NSP+_.MRouteParams,payload:[t]}}function w(e,t,r){if(!t._medux_.injectedModules[e]){var n=v.moduleGetter,o=n[e]();return"function"==typeof o.then?o.then((function(o){return n[e]=function(){return o},o.default.model(t,r)})):o.default.model(t,r)}}function E(e){return Array.isArray(e.payload)?e.payload:[]}function N(e,t,r,n,o){if(void 0===t&&(t={}),void 0===r&&(r={}),void 0===n&&(n=[]),void 0===o&&(o=[]),r.route)throw new Error("the reducer name 'route' is not allowed");r.route=function(e,t){if(t.type===_.RouteChange){var r=E(t)[0];return e?Object.assign({},e,{},r):r}return e};var a=i.applyMiddleware.apply(void 0,[function(){return function(e){return function(t){var r=t.type.split(h.NSP),n=r[0],o=r[1];if(n&&o&&v.moduleGetter[n]){var i=w(n,s,void 0);if(S(i))return i.then((function(){return e(t)}))}return e(t)}}}].concat(n,[function(e){var t=e.dispatch;return function(e){return function(r){if(v.isServer&&r.type.split(h.NSP)[1]===_.MLoading)return r;var n=s._medux_;n.beforeState=n.prevState;var o=e(r);if(o.type===_.RouteChange){var i=n.prevState.route.data.params;Object.keys(i).forEach((function(e){var r=i[e];r&&Object.keys(r).length>0&&n.injectedModules[e]&&t(M(e,r))}))}var a=n.effectMap[o.type]||{},u=n.effectMap[o.type.replace(new RegExp("[^"+h.NSP+"]+"),"*")]||{},c=Object.assign({},a,{},u),d=Object.keys(c);if(d.length>0){var f=[],l=o.priority?[].concat(o.priority):[];d.forEach((function(e){var t=c[e];e===v.appModuleName?f.unshift(e):f.push(e),t.__isHandler__||l.unshift(e)})),f.unshift.apply(f,l);var p={},m=[];if(f.forEach((function(e){if(!p[e]){p[e]=!0;var r=c[e],n=r.apply(void 0,E(o)),i=r.__decorators__;if(i){var a=[];i.forEach((function(t,r){a[r]=t[0](o,e,n)})),r.__decoratorResults__=a}var u=n.then((function(e){if(i){var t=r.__decoratorResults__||[];i.forEach((function(r,n){r[1]&&r[1]("Resolved",t[n],e)})),r.__decoratorResults__=void 0}return e}),(function(e){if(i){var n=r.__decoratorResults__||[];i.forEach((function(t,r){t[1]&&t[1]("Rejected",n[r],e)})),r.__decoratorResults__=void 0}if(o.type===_.Error)throw void 0===g(e)&&(e=function(e,t){return"object"==typeof e?(e.meduxProcessed=t,e):{meduxProcessed:t,error:e}}(e,!0)),e;if(g(e))throw e;return t(k(e))}));m.push(u)}})),m.length)return Promise.all(m)}return o}}}])),u=[].concat(o,[a,function(e){return function(){var t=e.apply(void 0,arguments),r=t;return r._medux_={beforeState:{},prevState:{},currentState:{},reducerMap:{},effectMap:{},injectedModules:{},currentViews:{}},t}}]);v.isDev&&m&&m.__REDUX_DEVTOOLS_EXTENSION__&&u.push(m.__REDUX_DEVTOOLS_EXTENSION__(m.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));var s=i.createStore((function(e,t){if(!s)return e;var n=s._medux_;n.prevState=e;var o=Object.assign({},e);n.currentState=o,Object.keys(r).forEach((function(e){o[e]=r[e](o[e],t)}));var i=n.reducerMap[t.type]||{},a=n.reducerMap[t.type.replace(new RegExp("[^"+h.NSP+"]+"),"*")]||{},u=Object.assign({},i,{},a),c=Object.keys(u);if(c.length>0){var d=[],f=t.priority?[].concat(t.priority):[];c.forEach((function(e){var t=u[e];e===v.appModuleName?d.unshift(e):d.push(e),t.__isHandler__||f.unshift(e)})),d.unshift.apply(d,f);var l={};d.forEach((function(e){if(!l[e]){l[e]=!0;var r=u[e];o[e]=r.apply(void 0,E(t))}}))}var p=Object.keys(e).length!==Object.keys(o).length||Object.keys(e).some((function(t){return e[t]!==o[t]}));return n.prevState=p?o:e,n.prevState}),t,i.compose.apply(void 0,u));return function(e,t){var r=!1,n=function(n){if(r)r=!1;else{var o=e.getState().route;if(o&&t.equal(o.location,n))return;var i=t.locationToRouteData(n);e.dispatch(P({location:n,data:i}))}};t.subscribe(n),e.subscribe((function(){if(t.initialized){var n=e.getState().route;t.equal(n.location,t.getLocation())||(r=!0,t.patch(n.location,n.data))}})),t.initialized&&n(t.getLocation())}(s,e),v.clientStore=s,s}var O=s(null,(function(e){return{F:function(t,r){this.moduleName=t,this.store=r,e(this)},d:[{kind:"field",key:"actions",value:function(){return null}},{kind:"get",key:"state",value:function(){return this.getState()}},{kind:"method",key:"getState",value:function(){return this.store._medux_.prevState[this.moduleName]}},{kind:"get",key:"rootState",value:function(){return this.getRootState()}},{kind:"method",key:"getRootState",value:function(){return this.store._medux_.prevState}},{kind:"get",key:"currentState",value:function(){return this.getCurrentState()}},{kind:"method",key:"getCurrentState",value:function(){return this.store._medux_.currentState[this.moduleName]}},{kind:"get",key:"currentRootState",value:function(){return this.getCurrentRootState()}},{kind:"method",key:"getCurrentRootState",value:function(){return this.store._medux_.currentState}},{kind:"get",key:"beforeState",value:function(){return this.getBeforeState()}},{kind:"method",key:"getBeforeState",value:function(){return this.store._medux_.beforeState[this.moduleName]}},{kind:"get",key:"beforeRootState",value:function(){return this.getBeforeRootState()}},{kind:"method",key:"getBeforeRootState",value:function(){return this.store._medux_.beforeState}},{kind:"method",key:"dispatch",value:function(e){return this.store.dispatch(e)}},{kind:"method",key:"callThisAction",value:function(e){for(var t=v.actionCreatorMap[this.moduleName],r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return t[e.__actionName__].apply(t,n)}},{kind:"method",key:"updateState",value:function(e){this.dispatch(this.callThisAction(this.Update,Object.assign({},this.getState(),{},e)))}},{kind:"method",key:"loadModel",value:function(e,t){return w(e,this.store,t)}},{kind:"method",decorators:[y],key:"Init",value:function(e,t,r){return Object.assign({},e,{routeParams:t||e.routeParams},r)}},{kind:"method",decorators:[y],key:"Update",value:function(e){return e}},{kind:"method",decorators:[y],key:"RouteParams",value:function(e){var t=this.getState();return Object.assign({},t,{routeParams:e})}},{kind:"method",decorators:[y],key:"Loading",value:function(e){var t=this.getState();return Object.assign({},t,{loading:Object.assign({},t.loading,{},e)})}}]}}));function R(e){return"function"==typeof e.then}function j(e,t){var r=e.map((function(e){var r=function(e,t){var r=t[e]();return R(r)?r.then((function(r){return t[e]=function(){return r},r})):r}(e,t);return R(r)?r:Promise.resolve(r)}));return Promise.all(r)}function T(){return(T=u(a.mark((function e(t,r,n,o,i){var u,s,c,d,f,l,p,_,m,S,y,g,b;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===i&&(i={}),v.appModuleName=n,u=i.ssrInitStoreKey||"meduxInitStore",s=N(o,i.initData,i.reducers,i.middlewares,i.enhancers),c=s.getState(),d=c.route.data,f=d.paths,l=d.views,console.log({paths:f,views:l}),0===f.length&&f.push(n),p=void 0,_={},m=0,S=f.length;case 11:if(!(m<S)){e.next=22;break}if(y=f[m].split(h.VSP),g=y[0],_[g]){e.next=19;break}return _[g]=!0,b=r[g](),e.next=18,b.default.model(s,void 0);case 18:0===m&&(p=b);case 19:m++,e.next=11;break;case 22:return e.abrupt("return",t(s,p.default.model,p.default.views,u));case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}exports.ActionTypes=_,exports.BaseModelHandlers=O,exports.config=h,exports.delayPromise=function(e){return function(t,r,n){r||n||(r=t.key,n=t.descriptor);var o=n.value;n.value=function(){for(var r=new Promise((function(t){setTimeout((function(){t(!0)}),1e3*e)})),n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return Promise.all([r,o.apply(t,i)]).then((function(e){return e[1]}))}}},exports.effect=function(e,t){return void 0===e&&(e="global",t=v.appModuleName),function(r,n,o){n||o||(n=r.key,o=r.descriptor);var i=o.value;if(i.__actionName__=n,i.__isEffect__=!0,o.enumerable=!0,e){i.__decorators__||(i.__decorators__=[]),i.__decorators__.push([function(r,n,o){v.isServer||(t||(t=n),p(o,t,e))},null])}return r.descriptor===o?r:o}},exports.errorAction=k,exports.exportActions=function(e){return v.moduleGetter=e,v.actionCreatorMap=Object.keys(e).reduce((function(e,t){return e[t]="undefined"==typeof Proxy?{}:new Proxy({},{get:function(e,r){return function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return{type:t+h.NSP+r,payload:n}}},set:function(){return!0}}),e}),{}),v.actionCreatorMap},exports.exportModule=function(e,t,r,n){var o=function(n,o){if(!n._medux_.injectedModules[e]){n._medux_.injectedModules[e]=!0;var i=n.getState()[e],a=new r(e,n),u=function(e,t,r){for(var n in r)"function"==typeof r[n]&&function(){var o,i,a,u=r[n];(u.__isReducer__||u.__isEffect__)&&(i=r,a=(o=u).bind(i),Object.keys(o).forEach((function(e){a[e]=o[e]})),u=a,n.split(h.MSP).forEach((function(r){(r=r.trim().replace(new RegExp("^this["+h.NSP+"]"),""+t+h.NSP)).split(h.NSP)[1]?(u.__isHandler__=!0,b(r,u,t,u.__isEffect__?e._medux_.effectMap:e._medux_.reducerMap)):(u.__isHandler__=!1,b(t+h.NSP+r,u,t,u.__isEffect__?e._medux_.effectMap:e._medux_.reducerMap),x(t,r))})))}();return v.actionCreatorMap[t]}(n,e,a);if(a.actions=u,!i){var s=n._medux_.prevState.route.data.params;t.isModule=!0;var c=u.Init(t,s[e],o);return n.dispatch(c)}}};o.moduleName=e,o.initState=t;return{moduleName:e,model:o,views:n,actions:{}}},exports.getActionData=E,exports.getClientStore=function(){return v.clientStore},exports.getView=function(e,t,r){var n=v.moduleGetter,o=n[e]();if(R(o))return o.then((function(o){n[e]=function(){return o};var i=o.default.views[t];if(v.isServer)return i;var a=o.default.model(v.clientStore,r);return S(a)?a.then((function(){return i})):i}));var i=o.default.views[t];if(v.isServer)return i;var a=o.default.model(v.clientStore,r);return S(a)?a.then((function(){return i})):i},exports.isPromiseModule=R,exports.isPromiseView=function(e){return"function"==typeof e.then},exports.isServer=function(){return v.isServer},exports.loadModel=w,exports.logger=function(e,t){return function(r,n,o){n||o||(n=r.key,o=r.descriptor);var i=o.value;i.__decorators__||(i.__decorators__=[]),i.__decorators__.push([e,t])}},exports.reducer=y,exports.renderApp=function(e,t,r,n,o){void 0===o&&(o={}),v.appModuleName=r;var i=o.ssrInitStoreKey||"meduxInitStore",a={};(o.initData||m[i])&&(a=Object.assign({},m[i],{},o.initData));var u=N(n,a,o.reducers,o.middlewares,o.enhancers),s=u.getState().route.data,c=s.paths,d=s.views;console.log({paths:c,views:d});var f=u,l=[r];return a&&l.push.apply(l,Object.keys(a).filter((function(e){return e!==r&&a[e].isModule}))),j(l,t).then((function(t){var r=t[0],n=r.default.model(u,void 0);return e(f,r.default.model,r.default.views,i),S(n)?n.then((function(){return f})):f}))},exports.renderSSR=function(e,t,r,n,o){return T.apply(this,arguments)},exports.routeChangeAction=P,exports.routeParamsAction=M,exports.setConfig=function(e){e.NSP&&(h.NSP=e.NSP),e.VSP&&(h.VSP=e.VSP),e.MSP&&(h.MSP=e.MSP)},exports.setLoading=p,exports.setLoadingDepthTime=function(e){l=e};
//# sourceMappingURL=index.min.js.map
