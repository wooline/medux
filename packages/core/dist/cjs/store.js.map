{"version":3,"sources":["../../src/store.ts"],"names":["getActionData","action","arr","Object","keys","filter","key","length","undefined","data","bindHistory","store","history","inTimeTravelling","handleLocationChange","location","getState","route","equal","locationToRouteData","dispatch","subscribe","initialized","storeRouteState","getLocation","patch","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","state","type","ActionTypes","RouteChange","payload","combineReducers","rootState","meta","_medux_","prevState","currentState","forEach","moduleName","handlersCommon","reducerMap","handlersEvery","replace","RegExp","config","NSP","handlers","handlerModules","orderList","priority","fun","MetaData","appModuleName","unshift","push","__isHandler__","moduleNameMap","routeParams","params","preRouteParams","changed","some","middleware","next","originalAction","isServer","split","MLoading","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","errorHandler","then","reslove","error","Promise","all","preLoadMiddleware","actionName","moduleGetter","initModel","middlewareEnhancer","applyMiddleware","enhancer","newCreateStore","newStore","modelStore","injectedModules","currentViews","enhancers","isDev","client","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","compose","clientStore"],"mappings":"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","sourcesContent":["import {Action, MetaData, ModelStore, RouteData, RouteState, StoreState, client, config, isProcessedError, isPromise, setProcessedError} from './basic';\nimport {ActionTypes, errorAction, routeChangeAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {injectModel} from './module';\n\nexport function getActionData<T>(action: Action): T {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined as any;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data as any;\n  }\n}\nexport interface HistoryProxy<L = any> {\n  initialized: boolean;\n  getLocation(): L;\n  subscribe(listener: (location: L) => void): void;\n  locationToRouteData(location: L): RouteData;\n  equal(a: L, b: L): boolean;\n  patch(location: L, routeData: RouteData): void;\n}\n\nfunction bindHistory<L>(store: ModelStore, history: HistoryProxy<L>) {\n  let inTimeTravelling = false;\n  const handleLocationChange = (location: L) => {\n    if (!inTimeTravelling) {\n      const {route} = store.getState() as StoreState;\n      if (route) {\n        if (history.equal(route.location, location)) {\n          return;\n        }\n      }\n      const data = history.locationToRouteData(location);\n      store.dispatch(routeChangeAction({location, data}));\n    } else {\n      inTimeTravelling = false;\n    }\n  };\n  history.subscribe(handleLocationChange);\n  store.subscribe(() => {\n    if (history.initialized) {\n      const storeRouteState = (store.getState() as StoreState).route;\n      if (!history.equal(storeRouteState.location, history.getLocation())) {\n        inTimeTravelling = true;\n        history.patch(storeRouteState.location, storeRouteState.data);\n      }\n    }\n  });\n  history.initialized && handleLocationChange(history.getLocation());\n}\n\nexport function buildStore(\n  history: HistoryProxy<any>,\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = []\n): ModelStore {\n  if (storeReducers.route) {\n    throw new Error(\"the reducer name 'route' is not allowed\");\n  }\n  storeReducers.route = (state: RouteState, action: Action) => {\n    if (action.type === ActionTypes.RouteChange) {\n      const payload: RouteState = getActionData(action);\n      if (!state) {\n        return payload;\n      }\n      return {...state, ...payload};\n    }\n    return state;\n  };\n  let store: ModelStore;\n  const combineReducers = (rootState: StoreState, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${config.NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = [];\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(getActionData(action));\n        }\n      });\n    }\n    if (action.type === ActionTypes.RouteChange) {\n      const routeParams = currentState.route.data.params;\n      Object.keys(routeParams).forEach(moduleName => {\n        if (currentState[moduleName]) {\n          currentState[moduleName] = {...currentState[moduleName], preRouteParams: routeParams[moduleName]};\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(config.NSP)[1] === ActionTypes.MLoading) {\n        return originalAction;\n      }\n    }\n    const prevState = store._medux_.prevState;\n    const action: Action = next(originalAction);\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${config.NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = [];\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(getActionData(action), prevState);\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          const errorHandler = effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (error: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], error);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              if (action.type === ActionTypes.Error) {\n                if (isProcessedError(error) === undefined) {\n                  error = setProcessedError(error, true);\n                }\n                throw error;\n              } else if (isProcessedError(error)) {\n                throw error;\n              } else {\n                return store.dispatch(errorAction(error)) as any;\n              }\n            }\n          );\n\n          promiseResults.push(errorHandler);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  const preLoadMiddleware = () => (next: Function) => (action: Action) => {\n    const [moduleName, actionName] = action.type.split(config.NSP);\n    if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n      const initModel = injectModel(MetaData.moduleGetter, moduleName, store);\n      if (isPromise(initModel)) {\n        return initModel.then(() => next(action));\n      }\n    }\n    return next(action);\n  };\n\n  const middlewareEnhancer = applyMiddleware(preLoadMiddleware, ...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._medux_ = {\n        prevState: {} as any,\n        currentState: {} as any,\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  bindHistory(store, history);\n  MetaData.clientStore = store;\n  return store;\n}\n"],"file":"store.js"}