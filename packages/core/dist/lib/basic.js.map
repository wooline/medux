{"version":3,"sources":["../../src/basic.ts"],"names":["setLoading","NSP","MetaData","isServer","global","window","isDev","process","env","NODE_ENV","actionCreatorMap","clientStore","appModuleName","client","undefined","getModuleActionCreatorList","namespace","obj","isPromise","data","getClientStore","reducer","target","key","descriptor","fun","value","__actionName__","__isReducer__","enumerable","effect","loadingForGroupName","loadingForModuleName","__isEffect__","before","curAction","moduleName","promiseResult","__decorators__","push","logger","after","delayPromise","second","propertyKey","delay","Promise","resolve","setTimeout","args","all","apply","then","items","bindThis","thisObj","newFun","bind","Object","keys","forEach","transformAction","actionName","action","listenerModule","actionHandlerMap","Error","addModuleActionCreatorList","actions","payload","type","injectActions","store","handlers","handler","arr","split","__isHandler__","_medux_","effectMap","reducerMap"],"mappings":"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","sourcesContent":["/*global global:true process:true*/\n\nimport {LoadingState} from './sprite';\nimport {setLoading} from './loading';\n\nexport const NSP = '/';\n\n// export const root: {__REDUX_DEVTOOLS_EXTENSION__?: any; __REDUX_DEVTOOLS_EXTENSION__OPTIONS?: any; onerror: any; onunhandledrejection: any} = ((typeof self == 'object' &&\n//   self.self === self &&\n//   self) ||\n//   (typeof global == 'object' && global.global === global && global) ||\n//   this) as any;\n\nexport const MetaData: {\n  isServer: boolean;\n  isDev: boolean;\n  actionCreatorMap: ActionCreatorMap;\n  clientStore: ModelStore;\n  appModuleName: string;\n} = {\n  isServer: typeof global !== 'undefined' && typeof window === 'undefined',\n  isDev: process.env.NODE_ENV !== 'production',\n  actionCreatorMap: {},\n  clientStore: null as any,\n  appModuleName: null as any,\n};\n\nexport const client = MetaData.isServer ? undefined : window || global;\nexport interface ActionCreatorMap {\n  [moduleName: string]: ActionCreatorList;\n}\nexport interface ActionCreatorList {\n  [actionName: string]: ActionCreator;\n}\nexport type ActionCreator = (payload?: any) => Action;\ninterface Store {\n  dispatch(action: Action): void;\n  getState(): {[key: string]: any};\n}\nexport interface ModelStore extends Store {\n  _medux_: {\n    reducerMap: ReducerMap;\n    effectMap: EffectMap;\n    injectedModules: {[namespace: string]: boolean};\n    currentViews: CurrentViews;\n    prevState: {[key: string]: any};\n    currentState: {[key: string]: any};\n  };\n}\nexport interface CurrentViews {\n  [moduleName: string]: {[viewName: string]: number};\n}\nexport interface ReducerHandler extends ActionHandler {\n  (payload?: any): BaseModuleState;\n}\nexport interface EffectHandler extends ActionHandler {\n  (payload?: any): Promise<any>;\n}\nexport interface ActionHandlerList {\n  [actionName: string]: ActionHandler;\n}\nexport interface ActionHandlerMap {\n  [actionName: string]: {[moduleName: string]: ActionHandler};\n}\nexport interface ReducerMap extends ActionHandlerMap {\n  [actionName: string]: {[moduleName: string]: ReducerHandler};\n}\nexport interface EffectMap extends ActionHandlerMap {\n  [actionName: string]: {[moduleName: string]: EffectHandler};\n}\nexport interface Action {\n  type: string;\n  priority?: string[];\n  payload?: any;\n}\nexport interface ActionHandler {\n  __actionName__: string;\n  __isReducer__?: boolean;\n  __isEffect__?: boolean;\n  __isHandler__?: boolean;\n  __decorators__?: [(action: Action, moduleName: string, effectResult: Promise<any>) => any, null | ((status: 'Rejected' | 'Resolved', beforeResult: any, effectResult: any) => void)][];\n  __decoratorResults__?: any[];\n  (payload?: any): any;\n}\nexport interface BaseModuleState {\n  isModule?: boolean;\n  loading?: {[key: string]: LoadingState};\n}\nexport function getModuleActionCreatorList(namespace: string): ActionCreatorList {\n  // if (window[\"Proxy\"]) {\n  //   actions = new window[\"Proxy\"](\n  //     {},\n  //     {\n  //       get: (target: {}, key: string) => {\n  //         return (data: any) => ({ type: namespace + \"/\" + key, data });\n  //       }\n  //     }\n  //   );\n  // } else {\n  //   actions = getModuleActions(namespace) as any;\n  // }\n  if (MetaData.actionCreatorMap[namespace]) {\n    return MetaData.actionCreatorMap[namespace];\n  } else {\n    const obj = {};\n    MetaData.actionCreatorMap[namespace] = obj;\n    return obj;\n  }\n}\nexport function isPromise(data: any): data is Promise<any> {\n  return typeof data['then'] === 'function';\n}\nexport function getClientStore() {\n  return MetaData.clientStore;\n}\nexport function isServer(): boolean {\n  return MetaData.isServer;\n}\nexport function reducer(target: any, key: string, descriptor: PropertyDescriptor) {\n  const fun = descriptor.value as ActionHandler;\n  fun.__actionName__ = key;\n  fun.__isReducer__ = true;\n  descriptor.enumerable = true;\n  return descriptor;\n}\nexport function effect(loadingForGroupName?: string | null, loadingForModuleName?: string) {\n  if (loadingForGroupName === undefined) {\n    loadingForGroupName = 'global';\n    loadingForModuleName = MetaData.appModuleName;\n  }\n  return (target: any, key: string, descriptor: PropertyDescriptor) => {\n    const fun = descriptor.value as ActionHandler;\n    fun.__actionName__ = key;\n    fun.__isEffect__ = true;\n    descriptor.enumerable = true;\n    if (loadingForGroupName) {\n      const before = (curAction: Action, moduleName: string, promiseResult: Promise<any>) => {\n        if (!MetaData.isServer) {\n          if (!loadingForModuleName) {\n            loadingForModuleName = moduleName;\n          }\n          setLoading(promiseResult, loadingForModuleName, loadingForGroupName as string);\n        }\n      };\n      if (!fun.__decorators__) {\n        fun.__decorators__ = [];\n      }\n      fun.__decorators__.push([before, null]);\n    }\n    return descriptor;\n  };\n}\nexport function logger(\n  before: (action: Action, moduleName: string, promiseResult: Promise<any>) => void,\n  after: null | ((status: 'Rejected' | 'Resolved', beforeResult: any, effectResult: any) => void)\n) {\n  return (target: any, key: string, descriptor: PropertyDescriptor) => {\n    const fun: ActionHandler = descriptor.value;\n    if (!fun.__decorators__) {\n      fun.__decorators__ = [];\n    }\n    fun.__decorators__.push([before, after]);\n  };\n}\nexport function delayPromise(second: number) {\n  return (target: any, propertyKey: string, descriptor: PropertyDescriptor) => {\n    const fun = descriptor.value;\n    descriptor.value = (...args: any[]) => {\n      const delay = new Promise(resolve => {\n        setTimeout(() => {\n          resolve(true);\n        }, second * 1000);\n      });\n      return Promise.all([delay, fun.apply(target, args)]).then(items => {\n        return items[1];\n      });\n    };\n  };\n}\nfunction bindThis(fun: ActionHandler, thisObj: any) {\n  const newFun = fun.bind(thisObj);\n  Object.keys(fun).forEach(key => {\n    newFun[key] = fun[key];\n  });\n\n  return newFun as ActionHandler;\n}\nfunction transformAction(actionName: string, action: ActionHandler, listenerModule: string, actionHandlerMap: ActionHandlerMap) {\n  if (!actionHandlerMap[actionName]) {\n    actionHandlerMap[actionName] = {};\n  }\n  if (actionHandlerMap[actionName][listenerModule]) {\n    throw new Error(`Action duplicate or conflict : ${actionName}.`);\n  }\n  actionHandlerMap[actionName][listenerModule] = action;\n}\n\nfunction addModuleActionCreatorList(namespace: string, actionName: string) {\n  const actions = getModuleActionCreatorList(namespace);\n  if (!actions[actionName]) {\n    actions[actionName] = payload => ({type: namespace + NSP + actionName, payload});\n  }\n}\nexport function injectActions(store: ModelStore, namespace: string, handlers: ActionHandlerList) {\n  for (const actionName in handlers) {\n    if (typeof handlers[actionName] === 'function') {\n      let handler = handlers[actionName];\n      if (handler.__isReducer__ || handler.__isEffect__) {\n        handler = bindThis(handler, handlers);\n        const arr = actionName.split(NSP);\n        if (arr[1]) {\n          handler.__isHandler__ = true;\n          transformAction(actionName, handler, namespace, handler.__isEffect__ ? store._medux_.effectMap : store._medux_.reducerMap);\n        } else {\n          handler.__isHandler__ = false;\n          transformAction(namespace + NSP + actionName, handler, namespace, handler.__isEffect__ ? store._medux_.effectMap : store._medux_.reducerMap);\n          addModuleActionCreatorList(namespace, actionName);\n        }\n      }\n    }\n  }\n  return getModuleActionCreatorList(namespace);\n}\n"],"file":"basic.js"}