{"version":3,"sources":["../../src/module.ts"],"names":["reducer","getModuleActionCreatorList","isPromise","injectActions","MetaData","buildStore","errorAction","exportModule","namespace","actions","BaseModuleHandlers","constructor","initState","presetData","store","isModule","state","_medux_","prevState","rootState","currentState","currentRootState","dispatch","action","callThisAction","handler","__actionName__","INIT","payload","UPDATE","LOADING","loading","updateState","exportModel","HandlersClass","fun","hasInjected","injectedModules","moduleState","getState","handlers","initAction","Promise","resolve","isPromiseModule","module","loadModel","getModule","result","then","model","getView","viewName","views","getModuleByName","moduleName","moduleGetter","getModuleListByNames","moduleNames","preModules","map","all","buildApp","render","appName","storeOptions","appModuleName","ssrInitStoreKey","initData","window","reducers","middlewares","enhancers","preModuleNames","push","Object","keys","filter","key","appModule","initModel","buildSSR","catch","err"],"mappings":"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","sourcesContent":["import {Middleware, ReducersMapObject, StoreEnhancer, Store} from 'redux';\nimport {Action, ActionHandler, ActionCreatorList, reducer, getModuleActionCreatorList, ModelStore, BaseModuleState, isPromise, injectActions, MetaData} from './basic';\nimport {buildStore} from './store';\nimport {errorAction} from './actions';\n\nexport interface Model<ModuleState = BaseModuleState> {\n  namespace: string;\n  initState: ModuleState;\n  (store: ModelStore): Promise<void>;\n}\n\nexport interface Module<M extends Model = Model, VS extends {[key: string]: any} = {[key: string]: any}> {\n  model: M;\n  views: VS;\n}\nexport type GetModule<M extends Module = Module> = () => M | Promise<M>;\n\nexport interface ModuleGetter {\n  [moduleName: string]: GetModule;\n}\nexport type ReturnModule<T extends () => any> = T extends () => Promise<infer R> ? R : T extends () => infer R ? R : Module;\nexport type ReturnViews<T extends () => any> = T extends () => Promise<Module<Model, infer R>> ? R : never;\ntype ModuleStates<M extends any> = M['model']['initState'];\ntype ModuleViews<M extends any> = {[key in keyof M['views']]?: number};\n\nexport type RootState<G extends ModuleGetter = {}> = {\n  views: {[key in keyof G]?: ModuleViews<ReturnModule<G[key]>>};\n} & {[key in keyof G]?: ModuleStates<ReturnModule<G[key]>>};\n\nexport function exportModule<T extends ActionCreatorList>(namespace: string) {\n  const actions: T = getModuleActionCreatorList(namespace) as T;\n  return {\n    namespace,\n    actions,\n  };\n}\nexport class BaseModuleHandlers<S extends BaseModuleState, R extends RootState<{}>, N extends string> {\n  protected readonly initState: S;\n  protected readonly namespace: N = '' as any;\n  protected readonly store: ModelStore = null as any;\n  protected readonly actions: Actions<this> = null as any;\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  public constructor(initState: S, presetData?: any) {\n    initState.isModule = true;\n    this.initState = initState;\n  }\n\n  protected get state(): S {\n    return this.store._medux_.prevState[this.namespace];\n  }\n\n  protected get rootState(): R {\n    return this.store._medux_.prevState as R;\n  }\n\n  protected get currentState(): S {\n    return this.store._medux_.currentState[this.namespace];\n  }\n\n  protected get currentRootState(): R {\n    return this.store._medux_.currentState as R;\n  }\n\n  protected dispatch(action: Action): Action | Promise<void> {\n    return this.store.dispatch(action) as any;\n  }\n\n  protected callThisAction<T extends any[]>(handler: (...args: T) => any, ...rest: T): {type: string; playload?: any} {\n    const actions = getModuleActionCreatorList(this.namespace);\n    return actions[(handler as ActionHandler).__actionName__](rest[0]);\n  }\n\n  @reducer\n  protected INIT(payload: S): S {\n    return payload;\n  }\n\n  @reducer\n  protected UPDATE(payload: S): S {\n    return payload;\n  }\n\n  @reducer\n  protected LOADING(payload: {[group: string]: string}): S {\n    const state = this.state;\n    if (!state) {\n      return state;\n    }\n    return {\n      ...state,\n      loading: {...state.loading, ...payload},\n    };\n  }\n\n  protected updateState(payload: Partial<S>) {\n    this.dispatch(this.callThisAction(this.UPDATE, {...this.state, ...payload}));\n  }\n}\n\ntype Handler<F> = F extends (...args: infer P) => any\n  ? (\n      ...args: P\n    ) => {\n      type: string;\n    }\n  : never;\n\nexport type Actions<Ins> = {[K in keyof Ins]: Ins[K] extends (...args: any[]) => any ? Handler<Ins[K]> : never};\nexport function exportModel<S extends BaseModuleState, N extends string>(\n  namespace: N,\n  HandlersClass: {new (initState: S, presetData?: any): BaseModuleHandlers<BaseModuleState, RootState<{}>, N>},\n  initState: S\n): Model<S> {\n  const fun = (store: ModelStore) => {\n    const hasInjected = store._medux_.injectedModules[namespace];\n    if (!hasInjected) {\n      store._medux_.injectedModules[namespace] = true;\n      const moduleState: BaseModuleState = store.getState()[namespace];\n      const handlers = new HandlersClass(initState, moduleState);\n      (handlers as any).namespace = namespace;\n      (handlers as any).store = store;\n      const actions = injectActions(store, namespace, handlers as any);\n      (handlers as any).actions = actions;\n      if (!moduleState) {\n        const initAction = actions.INIT((handlers as any).initState);\n        const action = store.dispatch(initAction);\n        if (isPromise(action)) {\n          return action;\n        } else {\n          return Promise.resolve(void 0);\n        }\n      } else {\n        return Promise.resolve(void 0);\n      }\n    } else {\n      return Promise.resolve(void 0);\n    }\n  };\n  fun.namespace = namespace;\n  fun.initState = initState;\n  return fun;\n}\nfunction isPromiseModule(module: Module | Promise<Module>): module is Promise<Module> {\n  return typeof module['then'] === 'function';\n}\nexport function loadModel<M extends Module>(getModule: GetModule<M>): Promise<M['model']> {\n  const result = getModule();\n  if (isPromiseModule(result)) {\n    return result.then(module => module.model);\n  } else {\n    return Promise.resolve(result.model);\n  }\n}\nexport function getView<M extends Module, N extends Extract<keyof M['views'], string>>(getModule: GetModule<M>, viewName: N): M['views'][N] | Promise<M['views'][N]> {\n  const result = getModule();\n  if (isPromiseModule(result)) {\n    return result.then(module => module.views[viewName]);\n  } else {\n    return result.views[viewName];\n  }\n}\nexport interface ExportView<C> {\n  (ComponentView: C, model: Model, viewName: string): C;\n}\nexport interface LoadView<MG extends ModuleGetter, M extends Extract<keyof MG, string>, V extends ReturnViews<MG[M]>, N extends Extract<keyof V, string>> {\n  (moduleGetter: MG, moduleName: M, viewName: N): V[N];\n}\nfunction getModuleByName(moduleName: string, moduleGetter: ModuleGetter): Promise<Module> | Module {\n  const result = moduleGetter[moduleName]();\n  if (isPromiseModule(result)) {\n    return result.then(module => {\n      moduleGetter[moduleName] = () => module;\n      return module;\n    });\n  } else {\n    return result;\n  }\n}\nfunction getModuleListByNames(moduleNames: string[], moduleGetter: ModuleGetter): Promise<Module[]> {\n  const preModules = moduleNames.map(moduleName => {\n    const module = getModuleByName(moduleName, moduleGetter);\n    if (isPromiseModule(module)) {\n      return module;\n    } else {\n      return Promise.resolve(module);\n    }\n  });\n  return Promise.all(preModules);\n}\nexport interface StoreOptions {\n  ssrInitStoreKey?: string;\n  reducers?: ReducersMapObject;\n  middlewares?: Middleware[];\n  enhancers?: StoreEnhancer[];\n  initData?: {[key: string]: any};\n}\nexport function buildApp<M extends ModuleGetter, A extends Extract<keyof M, string>>(\n  render: (store: Store, appModel: Model, appViews: {[key: string]: any}) => void,\n  moduleGetter: M,\n  appName: A,\n  storeOptions: StoreOptions = {}\n): Promise<void> {\n  MetaData.appModuleName = appName;\n  const ssrInitStoreKey = storeOptions.ssrInitStoreKey || 'meduxInitStore';\n  let initData = {};\n  if (storeOptions.initData || window[ssrInitStoreKey]) {\n    initData = {...window[ssrInitStoreKey], ...storeOptions.initData};\n  }\n  const store = buildStore(initData, storeOptions.reducers, storeOptions.middlewares, storeOptions.enhancers);\n  const preModuleNames: string[] = [appName];\n  if (initData) {\n    preModuleNames.push(...Object.keys(initData).filter(key => key !== appName && initData[key].isModule));\n  }\n  return getModuleListByNames(preModuleNames, moduleGetter).then(([appModule]) => {\n    const initModel = appModule.model(store);\n    render(store as any, appModule.model, appModule.views);\n    return initModel;\n  });\n}\nexport function buildSSR<M extends ModuleGetter, A extends Extract<keyof M, string>>(\n  render: (store: Store, appModel: Model, appViews: {[key: string]: any}, ssrInitStoreKey: string) => void,\n  moduleGetter: M,\n  appName: A,\n  storeOptions: StoreOptions = {}\n): Promise<void> {\n  MetaData.appModuleName = appName;\n  const ssrInitStoreKey = storeOptions.ssrInitStoreKey || 'meduxInitStore';\n  const store = buildStore(storeOptions.initData, storeOptions.reducers, storeOptions.middlewares, storeOptions.enhancers);\n  const appModule = moduleGetter[appName]() as Module;\n\n  return appModule\n    .model(store)\n    .catch(err => {\n      return store.dispatch(errorAction(err));\n    })\n    .then(() => {\n      render(store as any, appModule.model, appModule.views, ssrInitStoreKey);\n    });\n}\n"],"file":"module.js"}