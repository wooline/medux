{"version":3,"sources":["../../src/sprite.ts"],"names":["isPlainObject","obj","proto","Object","getPrototypeOf","TaskCountEvent","LoadingState","PEvent","constructor","name","data","bubbling","setTarget","target","setCurrentTarget","currentTarget","PDispatcher","parent","addListener","ename","handler","dictionary","storeHandlers","push","removeListener","keys","forEach","key","handlers","propertyIsEnumerable","n","indexOf","splice","length","dispatch","evt","i","k","setParent","TaskCounter","deferSecond","addItem","promise","note","list","some","item","then","completeItem","Start","ctimer","setTimeout","Depth","findIndex","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export function isPlainObject(obj: any): boolean {\n  if (typeof obj !== 'object' || obj === null) return false;\n\n  let proto = obj;\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\nexport const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}