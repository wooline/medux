{"version":3,"sources":["../../src/store.ts"],"names":["invalidViewTimer","checkInvalidview","currentViews","MetaData","clientStore","_meta_","views","moduleName","hasOwnProperty","element","viewname","dispatch","invalidview","getActionData","action","arr","key","length","undefined","data","simpleEqual","obj1","obj2","keys1","keys2","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","store","combineReducers","rootState","meta","prevState","currentState","namespace","type","ActionTypes","F_VIEW_INVALID","handlersCommon","reducerMap","handlersEvery","replace","RegExp","NSP","handlers","handlerModules","orderList","priority","fun","__isHandler__","push","unshift","moduleNameMap","changed","middleware","next","originalAction","isServer","split","M_LOADING","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","then","reslove","reject","all","middlewareEnhancer","applyMiddleware","enhancer","newCreateStore","newStore","modelStore","router","injectedModules","enhancers","isDev","root","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","compose","onerror","evt","source","fileno","columnNumber","error","onunhandledrejection","reason"],"mappings":"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","sourcesContent":["import {applyMiddleware, compose, createStore, Middleware, ReducersMapObject, StoreEnhancer} from 'redux';\nimport {Action, CurrentViews, MetaData, ModelStore, NSP, root} from './global';\nimport {isPlainObject} from 'sprite';\nimport {errorAction, viewInvalidAction, ActionTypes} from 'actions';\n\nlet invalidViewTimer: number;\n\nfunction checkInvalidview() {\n  invalidViewTimer = 0;\n  const currentViews = MetaData.clientStore._meta_.currentViews;\n  const views: CurrentViews = {};\n  for (const moduleName in currentViews) {\n    if (currentViews.hasOwnProperty(moduleName)) {\n      const element = currentViews[moduleName];\n      for (const viewname in element) {\n        if (element[viewname]) {\n          if (!views[moduleName]) {\n            views[moduleName] = {};\n          }\n          views[moduleName][viewname] = element[viewname];\n        }\n      }\n    }\n  }\n  MetaData.clientStore.dispatch(viewInvalidAction(views));\n}\n\nexport function invalidview() {\n  if (!invalidViewTimer) {\n    invalidViewTimer = setTimeout(checkInvalidview, 4);\n  }\n}\n\nfunction getActionData(action: Action) {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data;\n  }\n}\n\nfunction simpleEqual(obj1: any, obj2: any): boolean {\n  if (obj1 === obj2) {\n    return true;\n  } else if (typeof obj1 !== typeof obj2 || typeof obj1 !== 'object') {\n    return false;\n  } else {\n    const keys1 = Object.keys(obj1);\n    const keys2 = Object.keys(obj2);\n    if (keys1.length !== keys2.length) {\n      return false;\n    } else {\n      for (const key of keys1) {\n        if (!simpleEqual(obj1[key], obj2[key])) {\n          return false;\n        }\n      }\n      return true;\n    }\n  }\n}\n\nexport function buildStore(preloadedState: any = {}, storeReducers: ReducersMapObject<any, any> = {}, storeMiddlewares: Middleware[] = [], storeEnhancers: StoreEnhancer[] = []): ModelStore {\n  if (!isPlainObject(preloadedState)) {\n    throw new Error('preloadedState must be plain objects!');\n  }\n  if (!isPlainObject(storeReducers)) {\n    throw new Error('storeReducers must be plain objects!');\n  }\n  let store: ModelStore;\n  const combineReducers = (rootState: {[key: string]: any}, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._meta_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n\n    if (!currentState.views) {\n      currentState.views = {};\n    }\n    Object.keys(storeReducers).forEach(namespace => {\n      currentState[namespace] = storeReducers[namespace](currentState[namespace], action);\n    });\n    if (action.type === ActionTypes.F_VIEW_INVALID) {\n      const views: CurrentViews = getActionData(action);\n      if (!simpleEqual(currentState.views, views)) {\n        currentState.views = views;\n      }\n    }\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(namespace => {\n        const fun = handlers[namespace];\n        if (fun.__isHandler__) {\n          orderList.push(namespace);\n        } else {\n          orderList.unshift(namespace);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(namespace => {\n        if (!moduleNameMap[namespace]) {\n          moduleNameMap[namespace] = true;\n          const fun = handlers[namespace];\n          currentState[namespace] = fun(getActionData(action));\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(namespace => rootState[namespace] !== currentState[namespace]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(NSP)[1] === ActionTypes.M_LOADING) {\n        return originalAction;\n      }\n    }\n    const action: Action = next(originalAction);\n    const handlersCommon = store._meta_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._meta_.effectMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(namespace => {\n        const fun = handlers[namespace];\n        if (fun.__isHandler__) {\n          orderList.push(namespace);\n        } else {\n          orderList.unshift(namespace);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(namespace => {\n        if (!moduleNameMap[namespace]) {\n          moduleNameMap[namespace] = true;\n          const fun = handlers[namespace];\n          const effectResult = fun(getActionData(action));\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, namespace, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (reject: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], reject);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n            }\n          );\n          promiseResults.push(effectResult);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  // const enhancers = [applyMiddleware(...[effectMiddleware, routerMiddleware(storeHistory), ...storeMiddlewares]), ...storeEnhancers];\n  // if (MetaData.isBrowser && MetaData.isDev && window[\"__REDUX_DEVTOOLS_EXTENSION__\"]) {\n  //\n  // __REDUX_DEVTOOLS_EXTENSION_COMPOSE__\n  // enhancers.push(window[\"__REDUX_DEVTOOLS_EXTENSION__\"](window[\"__REDUX_DEVTOOLS_EXTENSION__OPTIONS\"]));\n  // }\n  // store = createStore(combineReducers as any, initData, compose(...enhancers));\n\n  const middlewareEnhancer = applyMiddleware(...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._meta_ = {\n        prevState: {router: null},\n        currentState: {router: null},\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && root.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(root.__REDUX_DEVTOOLS_EXTENSION__(root.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  MetaData.clientStore = store;\n  if (!MetaData.isServer) {\n    root.onerror = (evt: any, source?: string, fileno?: number, columnNumber?: number, error?: Error) => {\n      store.dispatch(errorAction(error || evt));\n    };\n    if ('onunhandledrejection' in root) {\n      root.onunhandledrejection = (error: any) => {\n        store.dispatch(errorAction(error.reason));\n      };\n    }\n  }\n  return store;\n}\n"],"file":"store.js"}