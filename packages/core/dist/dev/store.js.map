{"version":3,"sources":["../../src/store.ts"],"names":["MetaData","NSP","client","isPromise","ActionTypes","errorAction","viewInvalidAction","applyMiddleware","compose","createStore","injectModel","isPlainObject","invalidViewTimer","checkInvalidview","currentViews","clientStore","_medux_","views","moduleName","hasOwnProperty","element","viewname","dispatch","invalidview","isServer","setTimeout","viewWillMount","viewName","viewWillUnmount","getActionData","action","arr","Object","keys","filter","key","length","undefined","data","simpleEqual","obj1","obj2","keys1","keys2","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","store","combineReducers","rootState","meta","prevState","currentState","forEach","type","F_VIEW_INVALID","handlersCommon","reducerMap","handlersEvery","replace","RegExp","handlers","handlerModules","orderList","priority","fun","__isHandler__","push","unshift","moduleNameMap","changed","some","middleware","next","originalAction","split","M_LOADING","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","then","reslove","reject","Promise","all","middlewareEnhancer","enhancer","newCreateStore","newStore","modelStore","actionName","moduleGetter","initModel","router","injectedModules","enhancers","isDev","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","addEventListener","event","reason"],"mappings":"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","sourcesContent":["import {Action, CurrentViews, MetaData, ModelStore, NSP, client, isPromise} from './basic';\nimport {ActionTypes, errorAction, viewInvalidAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {injectModel} from './module';\nimport {isPlainObject} from './sprite';\n\nlet invalidViewTimer: number;\n\nfunction checkInvalidview() {\n  invalidViewTimer = 0;\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  const views: CurrentViews = {};\n  for (const moduleName in currentViews) {\n    if (currentViews.hasOwnProperty(moduleName)) {\n      const element = currentViews[moduleName];\n      for (const viewname in element) {\n        if (element[viewname]) {\n          if (!views[moduleName]) {\n            views[moduleName] = {};\n          }\n          views[moduleName][viewname] = element[viewname];\n        }\n      }\n    }\n  }\n  MetaData.clientStore.dispatch(viewInvalidAction(views));\n}\n\nexport function invalidview() {\n  if (MetaData.isServer) {\n    return;\n  }\n  if (!invalidViewTimer) {\n    invalidViewTimer = setTimeout(checkInvalidview, 0);\n  }\n}\n\nexport function viewWillMount(moduleName: string, viewName: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (!currentViews[moduleName]) {\n    currentViews[moduleName] = {[viewName]: 1};\n  } else {\n    const views = currentViews[moduleName];\n    if (!views[viewName]) {\n      views[viewName] = 1;\n    } else {\n      views[viewName]++;\n    }\n  }\n  invalidview();\n}\n\nexport function viewWillUnmount(moduleName: string, viewName: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (currentViews[moduleName] && currentViews[moduleName][viewName]) {\n    currentViews[moduleName][viewName]--;\n  }\n  invalidview();\n}\nfunction getActionData(action: Action) {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data;\n  }\n}\n\nfunction simpleEqual(obj1: any, obj2: any): boolean {\n  if (obj1 === obj2) {\n    return true;\n  } else if (typeof obj1 !== typeof obj2 || typeof obj1 !== 'object') {\n    return false;\n  } else {\n    const keys1 = Object.keys(obj1);\n    const keys2 = Object.keys(obj2);\n    if (keys1.length !== keys2.length) {\n      return false;\n    } else {\n      for (const key of keys1) {\n        if (!simpleEqual(obj1[key], obj2[key])) {\n          return false;\n        }\n      }\n      return true;\n    }\n  }\n}\n\nexport function buildStore(\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = []\n): ModelStore {\n  if (!isPlainObject(preloadedState)) {\n    throw new Error('preloadedState must be plain objects!');\n  }\n  if (!isPlainObject(storeReducers)) {\n    throw new Error('storeReducers must be plain objects!');\n  }\n  let store: ModelStore;\n  const combineReducers = (rootState: {[key: string]: any}, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n\n    if (!currentState.views) {\n      currentState.views = {};\n    }\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n    if (action.type === ActionTypes.F_VIEW_INVALID) {\n      const views: CurrentViews = getActionData(action);\n      if (!simpleEqual(currentState.views, views)) {\n        currentState.views = views;\n      }\n    }\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (fun.__isHandler__) {\n          orderList.push(moduleName);\n        } else {\n          orderList.unshift(moduleName);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(getActionData(action));\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(NSP)[1] === ActionTypes.M_LOADING) {\n        return originalAction;\n      }\n    }\n    const action: Action = next(originalAction);\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (fun.__isHandler__) {\n          orderList.push(moduleName);\n        } else {\n          orderList.unshift(moduleName);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(getActionData(action));\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (reject: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], reject);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n            }\n          );\n          promiseResults.push(effectResult);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  // const enhancers = [applyMiddleware(...[effectMiddleware, routerMiddleware(storeHistory), ...storeMiddlewares]), ...storeEnhancers];\n  // if (MetaData.isBrowser && MetaData.isDev && window[\"__REDUX_DEVTOOLS_EXTENSION__\"]) {\n  //\n  // __REDUX_DEVTOOLS_EXTENSION_COMPOSE__\n  // enhancers.push(window[\"__REDUX_DEVTOOLS_EXTENSION__\"](window[\"__REDUX_DEVTOOLS_EXTENSION__OPTIONS\"]));\n  // }\n  // store = createStore(combineReducers as any, initData, compose(...enhancers));\n\n  const middlewareEnhancer = applyMiddleware(...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const dispatch = newStore.dispatch;\n      const modelStore: ModelStore = newStore as any;\n      modelStore.dispatch = action => {\n        const [moduleName, actionName] = action.type.split(NSP);\n        if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n          const initModel = injectModel(MetaData.moduleGetter, moduleName, modelStore);\n          if (isPromise(initModel)) {\n            return initModel.then(() => dispatch<any>(action));\n          }\n        } else {\n          return dispatch<any>(action);\n        }\n      };\n      modelStore._medux_ = {\n        prevState: {router: null},\n        currentState: {router: null},\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  MetaData.clientStore = store;\n  if (client) {\n    if ('onerror' in client) {\n      client.addEventListener(\n        'error',\n        event => {\n          store.dispatch(errorAction(event));\n        },\n        true\n      );\n    }\n    if ('onunhandledrejection' in client) {\n      client.addEventListener(\n        'unhandledrejection',\n        event => {\n          store.dispatch(errorAction(event.reason));\n        },\n        true\n      );\n    }\n  }\n  return store;\n}\n"],"file":"store.js"}