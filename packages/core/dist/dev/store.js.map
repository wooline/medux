{"version":3,"sources":["../../src/store.ts"],"names":["MetaData","NSP","client","isPromise","ActionTypes","errorAction","routeChangeAction","applyMiddleware","compose","createStore","injectModel","isPlainObject","invalidViewTimer","checkInvalidview","currentViews","clientStore","_medux_","views","moduleName","hasOwnProperty","element","viewname","n","Object","keys","length","invalidview","isServer","setTimeout","viewWillMount","viewName","vid","viewWillUnmount","getActionData","action","arr","filter","key","undefined","data","bindHistory","store","history","inTimeTravelling","handleLocationChange","location","locationToRouteData","dispatch","subscribe","storeRouteState","getState","route","isTimeTravel","patch","getLocation","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","state","type","F_ROUTE_CHANGE","payload","combineReducers","rootState","meta","prevState","currentState","forEach","handlersCommon","reducerMap","handlersEvery","replace","RegExp","handlers","handlerModules","orderList","priority","fun","appModuleName","unshift","push","__isHandler__","moduleNameMap","changed","some","middleware","next","originalAction","split","M_LOADING","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","then","reslove","reject","Promise","all","preLoadMiddleware","actionName","moduleGetter","initModel","middlewareEnhancer","enhancer","newCreateStore","newStore","modelStore","router","injectedModules","enhancers","isDev","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","addEventListener","event","reason"],"mappings":"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","sourcesContent":["import {Action, BaseModelState, DisplayViews, MetaData, ModelStore, NSP, RouteData, RouteState, client, isPromise} from './basic';\nimport {ActionTypes, errorAction, routeChangeAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {injectModel} from './module';\nimport {isPlainObject} from './sprite';\n\n/**\n * dispatch push action\n * middleware 拦截并调用history.push\n * history触发侦听器，dispatch change action\n * store侦听器，判断是否时光\n */\n\nlet invalidViewTimer: number;\n\nfunction checkInvalidview() {\n  invalidViewTimer = 0;\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  const views: DisplayViews = {};\n  for (const moduleName in currentViews) {\n    if (currentViews.hasOwnProperty(moduleName)) {\n      const element = currentViews[moduleName];\n      for (const viewname in element) {\n        if (element[viewname]) {\n          const n = Object.keys(element[viewname]).length;\n          if (n) {\n            if (!views[moduleName]) {\n              views[moduleName] = {};\n            }\n            views[moduleName][viewname] = true;\n          }\n        }\n      }\n    }\n  }\n  // MetaData.clientStore.dispatch(viewInvalidAction(views));\n}\n\nexport function invalidview() {\n  if (MetaData.isServer) {\n    return;\n  }\n  if (!invalidViewTimer) {\n    invalidViewTimer = setTimeout(checkInvalidview, 300);\n  }\n}\n\nexport function viewWillMount(moduleName: string, viewName: string, vid: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (!currentViews[moduleName]) {\n    currentViews[moduleName] = {[viewName]: {[vid]: true}};\n  } else {\n    const views = currentViews[moduleName];\n    if (!views[viewName]) {\n      views[viewName] = {[vid]: true};\n    } else {\n      views[viewName][vid] = true;\n    }\n  }\n  invalidview();\n}\n\nexport function viewWillUnmount(moduleName: string, viewName: string, vid: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (currentViews[moduleName] && currentViews[moduleName][viewName]) {\n    const views = currentViews[moduleName][viewName];\n    delete views[vid];\n  }\n  invalidview();\n}\n\n// function excludeDefaultParams(data:any){\n//   return excludeDefaultData(data, MetaData.defaultRouteParams);\n// }\n// function excludeDefaultData(data: any, def: any) {\n//   const result: any = {};\n//   for (const key in data) {\n//     if (data.hasOwnProperty(key)) {\n//       const value = data[key];\n//       const defaultValue = def[key];\n//       if (value !== defaultValue) {\n//         if (typeof value === typeof defaultValue && typeof value === 'object' && !Array.isArray(value)) {\n//           result[key] = excludeDefaultData(value, defaultValue);\n//         } else {\n//           result[key] = value;\n//         }\n//       }\n//     }\n//   }\n//   if (Object.keys(result).length === 0) {\n//     return undefined;\n//   }\n//   return result;\n// }\n\nfunction getActionData(action: Action) {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data;\n  }\n}\nexport interface HistoryProxy<L = any> {\n  getLocation(): L;\n  subscribe(listener: (location: L) => void): void;\n  locationToRouteData(location: L): RouteData;\n  isTimeTravel(storeLocation: L): boolean;\n  patch(location: L, routeData: RouteData): void;\n}\n\nfunction bindHistory<L>(store: ModelStore, history: HistoryProxy<L>) {\n  let inTimeTravelling = false;\n  const handleLocationChange = (location: L) => {\n    if (!inTimeTravelling) {\n      const data = history.locationToRouteData(location);\n      store.dispatch(routeChangeAction({location, data}));\n    } else {\n      inTimeTravelling = false;\n    }\n  };\n  history.subscribe(handleLocationChange);\n  store.subscribe(() => {\n    const storeRouteState: RouteState<L> = store.getState().route;\n    if (history.isTimeTravel(storeRouteState.location)) {\n      inTimeTravelling = true;\n      history.patch(storeRouteState.location, storeRouteState.data);\n    }\n  });\n  handleLocationChange(history.getLocation());\n}\n\nexport function buildStore(\n  history: HistoryProxy<any>,\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = []\n): ModelStore {\n  if (!isPlainObject(preloadedState)) {\n    throw new Error('preloadedState must be plain objects!');\n  }\n  if (!isPlainObject(storeReducers)) {\n    throw new Error('storeReducers must be plain objects!');\n  }\n  if (storeReducers.route) {\n    throw new Error(\"the reducer name 'route' is not allowed\");\n  }\n  storeReducers.route = (state: RouteState, action: Action) => {\n    if (action.type === ActionTypes.F_ROUTE_CHANGE) {\n      const payload: RouteState = getActionData(action);\n      if (!state) {\n        return payload;\n      }\n      return {...state, ...payload};\n    }\n    return state;\n  };\n  let store: ModelStore;\n  const combineReducers = (rootState: {[moduleName: string]: BaseModelState}, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = []; //\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(getActionData(action));\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(NSP)[1] === ActionTypes.M_LOADING) {\n        return originalAction;\n      }\n    }\n    const action: Action = next(originalAction);\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (fun.__isHandler__) {\n          orderList.push(moduleName);\n        } else {\n          orderList.unshift(moduleName);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(getActionData(action));\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (reject: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], reject);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n            }\n          );\n          promiseResults.push(effectResult);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  const preLoadMiddleware = () => (next: Function) => (action: Action) => {\n    const [moduleName, actionName] = action.type.split(NSP);\n    if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n      const initModel = injectModel(MetaData.moduleGetter, moduleName, store);\n      if (isPromise(initModel)) {\n        return initModel.then(() => next(action));\n      }\n    }\n    return next(action);\n  };\n\n  const middlewareEnhancer = applyMiddleware(preLoadMiddleware, ...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._medux_ = {\n        prevState: {router: null},\n        currentState: {router: null},\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  bindHistory(store, history);\n  MetaData.clientStore = store;\n  if (client) {\n    if ('onerror' in client) {\n      client.addEventListener(\n        'error',\n        event => {\n          store.dispatch(errorAction(event));\n        },\n        true\n      );\n    }\n    if ('onunhandledrejection' in client) {\n      client.addEventListener(\n        'unhandledrejection',\n        event => {\n          store.dispatch(errorAction(event.reason));\n        },\n        true\n      );\n    }\n  }\n  return store;\n}\n"],"file":"store.js"}