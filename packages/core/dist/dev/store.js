"use strict";var _interopRequireDefault=require("@babel/runtime-corejs3/helpers/interopRequireDefault");var _Object$defineProperty=require("@babel/runtime-corejs3/core-js-stable/object/define-property");require("core-js/modules/es.array.iterator"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.promise"),require("core-js/modules/es.regexp.constructor"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.iterator"),require("core-js/modules/es.string.replace"),require("core-js/modules/es.string.split"),require("core-js/modules/web.dom-collections.iterator");_Object$defineProperty(exports,"__esModule",{value:!0}),exports.invalidview=invalidview,exports.buildStore=buildStore;var invalidViewTimer,_concat=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/concat")),_promise=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/promise")),_some=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/some")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/toConsumableArray")),_forEach=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each")),_getIterator2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js/get-iterator")),_typeof2=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/typeof")),_objectSpread2=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/objectSpread")),_keys=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys")),_filter=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/filter")),_setTimeout2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/set-timeout")),_redux=require("redux"),_global=require("./global"),_sprite=require("sprite"),_actions=require("actions");function checkInvalidview(){invalidViewTimer=0;var a=_global.MetaData.clientStore._meta_.currentViews,b={};for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];for(var e in d)d[e]&&(b[c]||(b[c]={}),b[c][e]=d[e])}_global.MetaData.clientStore.dispatch((0,_actions.viewInvalidAction)(b))}function invalidview(){invalidViewTimer||(invalidViewTimer=(0,_setTimeout2.default)(checkInvalidview,4))}function getActionData(a){var b,c=(0,_filter.default)(b=(0,_keys.default)(a)).call(b,function(a){return"type"!==a&&"priority"!==a&&"time"!==a});if(0!==c.length){if(1===c.length)return a[c[0]];var d=(0,_objectSpread2.default)({},a);return delete d.type,delete d.priority,delete d.time,d}}function simpleEqual(a,b){if(a===b)return!0;if((0,_typeof2.default)(a)!==(0,_typeof2.default)(b)||"object"!==(0,_typeof2.default)(a))return!1;var c=(0,_keys.default)(a),d=(0,_keys.default)(b);if(c.length!==d.length)return!1;var e=!0,f=!1,g=void 0;try{for(var h,i,j=(0,_getIterator2.default)(c);!(e=(h=j.next()).done);e=!0)if(i=h.value,!simpleEqual(a[i],b[i]))return!1}catch(a){f=!0,g=a}finally{try{e||null==j.return||j.return()}finally{if(f)throw g}}return!0}function buildStore(){var a,b,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];if(!(0,_sprite.isPlainObject)(c))throw new Error("preloadedState must be plain objects!");if(!(0,_sprite.isPlainObject)(d))throw new Error("storeReducers must be plain objects!");var g,h=function(a,b){var c,e;if(!g)return a;var f=g._meta_;f.prevState=a;var h=(0,_objectSpread2.default)({},a);if(f.currentState=h,h.views||(h.views={}),(0,_forEach.default)(c=(0,_keys.default)(d)).call(c,function(a){h[a]=d[a](h[a],b)}),b.type===_actions.ActionTypes.F_VIEW_INVALID){var n=getActionData(b);simpleEqual(h.views,n)||(h.views=n)}var i=f.reducerMap[b.type]||{},j=f.reducerMap[b.type.replace(new RegExp("[^".concat(_global.NSP,"]+")),"*")]||{},k=(0,_objectSpread2.default)({},i,j),l=(0,_keys.default)(k);// 支持泛监听，形如 */loading
if(0<l.length){var o=b.priority?(0,_toConsumableArray2.default)(b.priority):[];(0,_forEach.default)(l).call(l,function(a){var b=k[a];b.__isHandler__?o.push(a):o.unshift(a)});var p={};(0,_forEach.default)(o).call(o,function(a){if(!p[a]){p[a]=!0;var c=k[a];h[a]=c(getActionData(b))}})}var m=(0,_keys.default)(a).length!==(0,_keys.default)(h).length||(0,_some.default)(e=(0,_keys.default)(a)).call(e,function(b){return a[b]!==h[b]});return f.prevState=m?h:a,f.prevState},i=_redux.applyMiddleware.apply(void 0,(0,_concat.default)(a=(0,_toConsumableArray2.default)(e)).call(a,[function middleware(){return function(a){return function(b){if(_global.MetaData.isServer&&b.type.split(_global.NSP)[1]===_actions.ActionTypes.M_LOADING)return b;var c=a(b),d=g._meta_.effectMap[c.type]||{},e=g._meta_.effectMap[c.type.replace(new RegExp("[^".concat(_global.NSP,"]+")),"*")]||{},f=(0,_objectSpread2.default)({},d,e),h=(0,_keys.default)(f);if(0<h.length){var k=c.priority?(0,_toConsumableArray2.default)(c.priority):[];(0,_forEach.default)(h).call(h,function(a){var b=f[a];b.__isHandler__?k.push(a):k.unshift(a)});var i={},j=[];if((0,_forEach.default)(k).call(k,function(a){if(!i[a]){i[a]=!0;var b=f[a],d=b(getActionData(c)),e=b.__decorators__;if(e){var g=[];(0,_forEach.default)(e).call(e,function(b,e){g[e]=b[0](c,a,d)}),b.__decoratorResults__=g}d.then(function(a){if(e){var c=b.__decoratorResults__||[];(0,_forEach.default)(e).call(e,function(b,d){b[1]&&b[1]("Resolved",c[d],a)}),b.__decoratorResults__=void 0}return a},function(a){if(e){var c=b.__decoratorResults__||[];(0,_forEach.default)(e).call(e,function(b,d){b[1]&&b[1]("Rejected",c[d],a)}),b.__decoratorResults__=void 0}}),j.push(d)}}),j.length)return _promise.default.all(j)}return c}}}])),j=(0,_concat.default)(b=[]).call(b,(0,_toConsumableArray2.default)(f),[i,function enhancer(a){return function(){var b=a.apply(void 0,arguments);return b._meta_={prevState:{router:null},currentState:{router:null},reducerMap:{},effectMap:{},injectedModules:{},currentViews:{}},b}}]);return _global.MetaData.isDev&&_global.root.__REDUX_DEVTOOLS_EXTENSION__&&j.push(_global.root.__REDUX_DEVTOOLS_EXTENSION__(_global.root.__REDUX_DEVTOOLS_EXTENSION__OPTIONS)),g=(0,_redux.createStore)(h,c,_redux.compose.apply(void 0,(0,_toConsumableArray2.default)(j))),_global.MetaData.clientStore=g,_global.MetaData.isServer||(_global.root.onerror=function(a,b,c,d,e){g.dispatch((0,_actions.errorAction)(e||a))},"onunhandledrejection"in _global.root&&(_global.root.onunhandledrejection=function(a){g.dispatch((0,_actions.errorAction)(a.reason))})),g}
//# sourceMappingURL=store.js.map