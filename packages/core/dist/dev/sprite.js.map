{"version":3,"sources":["../../src/sprite.ts"],"names":["TaskCountEvent","LoadingState","PEvent","name","data","bubbling","setTarget","target","setCurrentTarget","currentTarget","PDispatcher","parent","addListener","ename","handler","dictionary","storeHandlers","push","removeListener","Object","keys","forEach","key","handlers","propertyIsEnumerable","n","indexOf","splice","length","dispatch","evt","i","k","setParent","TaskCounter","deferSecond","addItem","promise","note","list","some","item","then","completeItem","Start","ctimer","setTimeout","Depth","findIndex","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}