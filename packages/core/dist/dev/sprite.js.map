{"version":3,"sources":["../../src/sprite.ts"],"names":["isPlainObject","obj","proto","Object","getPrototypeOf","TaskCountEvent","LoadingState","PEvent","name","data","bubbling","target","currentTarget","setTarget","setCurrentTarget","PDispatcher","parent","storeHandlers","addListener","ename","handler","dictionary","push","removeListener","keys","forEach","key","handlers","propertyIsEnumerable","n","indexOf","splice","length","dispatch","evt","i","k","setParent","TaskCounter","deferSecond","list","ctimer","addItem","promise","note","some","item","then","completeItem","Start","setTimeout","Depth","findIndex","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export function isPlainObject(obj: any): boolean {\n  if (typeof obj !== 'object' || obj === null) return false;\n\n  let proto = obj;\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\nexport const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}