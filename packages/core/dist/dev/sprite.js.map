{"version":3,"sources":["../../src/sprite.ts"],"names":["isPlainObject","obj","proto","TaskCountEvent","LoadingState","PEvent","name","data","bubbling","target","currentTarget","PDispatcher","parent","ename","handler","dictionary","storeHandlers","push","key","handlers","propertyIsEnumerable","n","length","evt","setTarget","setCurrentTarget","i","k","dispatch","TaskCounter","deferSecond","promise","note","list","item","then","completeItem","Start","ctimer","Depth","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export function isPlainObject(obj: any): boolean {\n  if (typeof obj !== 'object' || obj === null) return false;\n\n  let proto = obj;\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\nexport const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}