{"version":3,"sources":["../../src/sprite.ts"],"names":["isPlainObject","obj","proto","TaskCountEvent","LoadingState","PEvent","name","data","bubbling","target","currentTarget","PDispatcher","parent","ename","handler","dictionary","storeHandlers","push","key","handlers","propertyIsEnumerable","n","length","evt","setTarget","setCurrentTarget","i","k","dispatch","TaskCounter","deferSecond","promise","note","list","item","then","completeItem","Start","ctimer","Depth","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export function isPlainObject(obj: any): boolean {\n  if (typeof obj !== 'object' || obj === null) return false;\n\n  let proto = obj;\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\nexport const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}