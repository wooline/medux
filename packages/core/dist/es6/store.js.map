{"version":3,"sources":["../../src/store.ts"],"names":["MetaData","client","config","isProcessedError","isPromise","setProcessedError","ActionTypes","errorAction","preRouteParamsAction","routeChangeAction","applyMiddleware","compose","createStore","loadModel","getActionData","action","Array","isArray","payload","bindHistory","store","history","inTimeTravelling","handleLocationChange","location","route","getState","equal","data","locationToRouteData","dispatch","subscribe","initialized","storeRouteState","getLocation","patch","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","state","type","RouteChange","combineReducers","rootState","meta","_medux_","prevState","currentState","Object","keys","forEach","moduleName","handlersCommon","reducerMap","handlersEvery","replace","RegExp","NSP","handlers","handlerModules","length","orderList","priority","fun","appModuleName","unshift","push","__isHandler__","moduleNameMap","changed","some","middleware","next","originalAction","isServer","split","MLoading","rootRouteParams","params","preRouteParams","injectedModules","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","errorHandler","then","reslove","undefined","error","Promise","all","preLoadMiddleware","actionName","moduleGetter","initModel","middlewareEnhancer","enhancer","newCreateStore","newStore","modelStore","currentViews","enhancers","isDev","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","clientStore"],"mappings":"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","sourcesContent":["import {Action, MetaData, ModelStore, RouteData, RouteState, StoreState, client, config, isProcessedError, isPromise, setProcessedError} from './basic';\nimport {ActionTypes, errorAction, preRouteParamsAction, routeChangeAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {loadModel} from './module';\n\nexport function getActionData(action: Action): any[] {\n  return Array.isArray(action.payload) ? action.payload : [];\n  // const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  // if (arr.length === 0) {\n  //   return undefined as any;\n  // } else if (arr.length === 1) {\n  //   return action[arr[0]];\n  // } else {\n  //   const data = {...action};\n  //   delete data['type'];\n  //   delete data['priority'];\n  //   delete data['time'];\n  //   return data as any;\n  // }\n}\nexport interface HistoryProxy<L = any> {\n  initialized: boolean;\n  getLocation(): L;\n  subscribe(listener: (location: L) => void): void;\n  locationToRouteData(location: L): RouteData;\n  equal(a: L, b: L): boolean;\n  patch(location: L, routeData: RouteData): void;\n}\n\nfunction bindHistory<L>(store: ModelStore, history: HistoryProxy<L>) {\n  let inTimeTravelling = false;\n  const handleLocationChange = (location: L) => {\n    if (!inTimeTravelling) {\n      const {route} = store.getState() as StoreState;\n      if (route) {\n        if (history.equal(route.location, location)) {\n          return;\n        }\n      }\n      const data = history.locationToRouteData(location);\n      store.dispatch(routeChangeAction({location, data}));\n    } else {\n      inTimeTravelling = false;\n    }\n  };\n  history.subscribe(handleLocationChange);\n  store.subscribe(() => {\n    if (history.initialized) {\n      const storeRouteState = (store.getState() as StoreState).route;\n      if (!history.equal(storeRouteState.location, history.getLocation())) {\n        inTimeTravelling = true;\n        history.patch(storeRouteState.location, storeRouteState.data);\n      }\n    }\n  });\n  history.initialized && handleLocationChange(history.getLocation());\n}\n\nexport function buildStore(\n  history: HistoryProxy<any>,\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = []\n): ModelStore {\n  if (storeReducers.route) {\n    throw new Error(\"the reducer name 'route' is not allowed\");\n  }\n  storeReducers.route = (state: RouteState, action: Action) => {\n    if (action.type === ActionTypes.RouteChange) {\n      const payload: RouteState = getActionData(action)[0];\n      if (!state) {\n        return payload;\n      }\n      return {...state, ...payload};\n    }\n    return state;\n  };\n\n  const combineReducers = (rootState: StoreState, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${config.NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = [];\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(...getActionData(action));\n        }\n      });\n    }\n\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n  const middleware = ({dispatch}: {dispatch: Function}) => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(config.NSP)[1] === ActionTypes.MLoading) {\n        return originalAction;\n      }\n    }\n    const prevState = store._medux_.prevState;\n    const action: Action = next(originalAction);\n    if (action.type === ActionTypes.RouteChange) {\n      const rootRouteParams = store._medux_.prevState.route.data.params;\n      Object.keys(rootRouteParams).forEach(moduleName => {\n        const preRouteParams = rootRouteParams[moduleName];\n        if (preRouteParams && Object.keys(preRouteParams).length > 0 && store._medux_.injectedModules[moduleName]) {\n          dispatch(preRouteParamsAction(moduleName, preRouteParams));\n        }\n      });\n    }\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${config.NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = [];\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(...getActionData(action), prevState);\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          const errorHandler = effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (error: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], error);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              if (action.type === ActionTypes.Error) {\n                if (isProcessedError(error) === undefined) {\n                  error = setProcessedError(error, true);\n                }\n                throw error;\n              } else if (isProcessedError(error)) {\n                throw error;\n              } else {\n                return dispatch(errorAction(error)) as any;\n              }\n            }\n          );\n\n          promiseResults.push(errorHandler);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  const preLoadMiddleware = () => (next: Function) => (action: Action) => {\n    const [moduleName, actionName] = action.type.split(config.NSP);\n    if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n      const initModel = loadModel(moduleName, store);\n      if (isPromise(initModel)) {\n        return initModel.then(() => next(action));\n      }\n    }\n    return next(action);\n  };\n\n  const middlewareEnhancer = applyMiddleware(preLoadMiddleware, ...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._medux_ = {\n        prevState: {} as any,\n        currentState: {} as any,\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  const store: ModelStore = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  bindHistory(store, history);\n  MetaData.clientStore = store;\n  return store;\n}\n"],"file":"store.js"}