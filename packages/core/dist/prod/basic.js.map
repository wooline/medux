{"version":3,"sources":["../../src/basic.ts"],"names":["setLoading","NSP","VSP","MetaData","isServer","global","window","isDev","process","env","NODE_ENV","actionCreatorMap","clientStore","appModuleName","moduleGetter","defaultRouteParams","client","isPromise","data","getStore","reducer","target","key","descriptor","fun","value","__actionName__","__isReducer__","enumerable","effect","loadingForGroupName","loadingForModuleName","__isEffect__","before","curAction","moduleName","promiseResult","__decorators__","push","logger","after","delayPromise","second","delay","Promise","resolve","setTimeout","args","all","apply","then","items","isProcessedError","error","meduxProcessed","setProcessedError","bindThis","thisObj","newFun","bind","Object","keys","forEach","transformAction","actionName","action","listenerModule","actionHandlerMap","Error","addModuleActionCreatorList","actions","payload","type","injectActions","store","handlers","actionNames","handler","split","trim","replace","arr","__isHandler__","_medux_","effectMap","reducerMap"],"mappings":"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","sourcesContent":["/*global global:true process:true*/\nimport {LoadingState} from './sprite';\nimport {ModuleGetter} from './module';\nimport {setLoading} from './loading';\n\nexport const NSP = '/';\nexport const VSP = '.';\n\n// export const root: {__REDUX_DEVTOOLS_EXTENSION__?: any; __REDUX_DEVTOOLS_EXTENSION__OPTIONS?: any; onerror: any; onunhandledrejection: any} = ((typeof self == 'object' &&\n//   self.self === self &&\n//   self) ||\n//   (typeof global == 'object' && global.global === global && global) ||\n//   this) as any;\n\nexport const MetaData: {\n  isServer: boolean;\n  isDev: boolean;\n  actionCreatorMap: ActionCreatorMap;\n  clientStore: ModelStore;\n  appModuleName: string;\n  moduleGetter: ModuleGetter;\n  defaultRouteParams: {[moduleName: string]: {[key: string]: any} | undefined};\n} = {\n  isServer: typeof global !== 'undefined' && typeof window === 'undefined',\n  isDev: process.env.NODE_ENV !== 'production',\n  actionCreatorMap: null as any,\n  clientStore: null as any,\n  appModuleName: null as any,\n  moduleGetter: null as any,\n  defaultRouteParams: {},\n};\nexport const defaultRouteParams = MetaData.defaultRouteParams;\nexport const client: Window | undefined = MetaData.isServer ? undefined : typeof window === 'undefined' ? (global as any) : window;\nexport interface ActionCreatorMap {\n  [moduleName: string]: ActionCreatorList;\n}\nexport interface ActionCreatorList {\n  [actionName: string]: ActionCreator;\n}\nexport type ActionCreator = (payload?: any) => Action;\ninterface Store {\n  dispatch(action: Action): Action | Promise<void>;\n  getState(): {[key: string]: any};\n  subscribe(listener: () => void): void;\n}\nexport interface ModelStore extends Store {\n  _medux_: {\n    reducerMap: ReducerMap;\n    effectMap: EffectMap;\n    injectedModules: {[moduleName: string]: boolean};\n    currentViews: CurrentViews;\n    prevState: StoreState;\n    currentState: StoreState;\n  };\n}\nexport interface RouteData {\n  views: DisplayViews;\n  params: {[moduleName: string]: {[key: string]: any} | undefined};\n  paths: string[];\n}\nexport interface RouteState<L = any> {\n  location: L;\n  data: RouteData;\n}\nexport type StoreState = {\n  [moduleName: string]: BaseModelState;\n} & {route: RouteState};\n\nexport interface DisplayViews {\n  [moduleName: string]: {[viewName: string]: boolean | undefined} | undefined;\n}\nexport interface CurrentViews {\n  [moduleName: string]: {[viewName: string]: {[key: string]: boolean}};\n}\nexport interface ReducerHandler extends ActionHandler {\n  (payload?: any): BaseModelState;\n}\nexport interface EffectHandler extends ActionHandler {\n  (payload?: any): Promise<any>;\n}\nexport interface ActionHandlerList {\n  [actionName: string]: ActionHandler;\n}\nexport interface ActionHandlerMap {\n  [actionName: string]: {[moduleName: string]: ActionHandler};\n}\nexport interface ReducerMap extends ActionHandlerMap {\n  [actionName: string]: {[moduleName: string]: ReducerHandler};\n}\nexport interface EffectMap extends ActionHandlerMap {\n  [actionName: string]: {[moduleName: string]: EffectHandler};\n}\nexport interface Action<P = any> {\n  type: string;\n  priority?: string[];\n  payload?: P;\n}\nexport interface ActionHandler {\n  __actionName__: string;\n  __isReducer__?: boolean;\n  __isEffect__?: boolean;\n  __isHandler__?: boolean;\n  __decorators__?: [(action: Action, moduleName: string, effectResult: Promise<any>) => any, null | ((status: 'Rejected' | 'Resolved', beforeResult: any, effectResult: any) => void)][];\n  __decoratorResults__?: any[];\n  (payload?: any): any;\n}\nexport interface BaseModelState<R = {[key: string]: any}> {\n  isModule?: boolean;\n  routeParams?: R;\n  loading?: {\n    [key: string]: LoadingState;\n  };\n}\n\nexport function isPromise(data: any): data is Promise<any> {\n  return typeof data === 'object' && typeof data['then'] === 'function';\n}\nexport function getStore() {\n  return MetaData.clientStore;\n}\nexport function isServer(): boolean {\n  return MetaData.isServer;\n}\nexport function reducer(target: any, key: string, descriptor: PropertyDescriptor) {\n  if (!key && !descriptor) {\n    key = target.key;\n    descriptor = target.descriptor;\n  }\n  const fun = descriptor.value as ActionHandler;\n  fun.__actionName__ = key;\n  fun.__isReducer__ = true;\n  descriptor.enumerable = true;\n  return target.descriptor === descriptor ? target : descriptor;\n}\nexport function effect(loadingForGroupName?: string | null, loadingForModuleName?: string) {\n  if (loadingForGroupName === undefined) {\n    loadingForGroupName = 'global';\n    loadingForModuleName = MetaData.appModuleName;\n  }\n  return (target: any, key: string, descriptor: PropertyDescriptor) => {\n    if (!key && !descriptor) {\n      key = target.key;\n      descriptor = target.descriptor;\n    }\n    const fun = descriptor.value as ActionHandler;\n    fun.__actionName__ = key;\n    fun.__isEffect__ = true;\n    descriptor.enumerable = true;\n    if (loadingForGroupName) {\n      const before = (curAction: Action, moduleName: string, promiseResult: Promise<any>) => {\n        if (!MetaData.isServer) {\n          if (!loadingForModuleName) {\n            loadingForModuleName = moduleName;\n          }\n          setLoading(promiseResult, loadingForModuleName, loadingForGroupName as string);\n        }\n      };\n      if (!fun.__decorators__) {\n        fun.__decorators__ = [];\n      }\n      fun.__decorators__.push([before, null]);\n    }\n    return target.descriptor === descriptor ? target : descriptor;\n  };\n}\nexport function logger(\n  before: (action: Action, moduleName: string, promiseResult: Promise<any>) => void,\n  after: null | ((status: 'Rejected' | 'Resolved', beforeResult: any, effectResult: any) => void)\n) {\n  return (target: any, key: string, descriptor: PropertyDescriptor) => {\n    if (!key && !descriptor) {\n      key = target.key;\n      descriptor = target.descriptor;\n    }\n    const fun: ActionHandler = descriptor.value;\n    if (!fun.__decorators__) {\n      fun.__decorators__ = [];\n    }\n    fun.__decorators__.push([before, after]);\n  };\n}\nexport function delayPromise(second: number) {\n  return (target: any, key: string, descriptor: PropertyDescriptor) => {\n    if (!key && !descriptor) {\n      key = target.key;\n      descriptor = target.descriptor;\n    }\n    const fun = descriptor.value;\n    descriptor.value = (...args: any[]) => {\n      const delay = new Promise(resolve => {\n        setTimeout(() => {\n          resolve(true);\n        }, second * 1000);\n      });\n      return Promise.all([delay, fun.apply(target, args)]).then(items => {\n        return items[1];\n      });\n    };\n  };\n}\nexport function isProcessedError(error: any): boolean | undefined {\n  if (typeof error !== 'object' || error.meduxProcessed === undefined) {\n    return undefined;\n  } else {\n    return !!error.meduxProcessed;\n  }\n}\nexport function setProcessedError(error: any, meduxProcessed: boolean): {meduxProcessed: boolean; [key: string]: any} {\n  if (typeof error === 'object') {\n    error.meduxProcessed = meduxProcessed;\n    return error;\n  } else {\n    return {\n      meduxProcessed,\n      error,\n    };\n  }\n}\nfunction bindThis(fun: ActionHandler, thisObj: any) {\n  const newFun = fun.bind(thisObj);\n  Object.keys(fun).forEach(key => {\n    newFun[key] = fun[key];\n  });\n\n  return newFun as ActionHandler;\n}\nfunction transformAction(actionName: string, action: ActionHandler, listenerModule: string, actionHandlerMap: ActionHandlerMap) {\n  if (!actionHandlerMap[actionName]) {\n    actionHandlerMap[actionName] = {};\n  }\n  if (actionHandlerMap[actionName][listenerModule]) {\n    throw new Error(`Action duplicate or conflict : ${actionName}.`);\n  }\n  actionHandlerMap[actionName][listenerModule] = action;\n}\n\nfunction addModuleActionCreatorList(moduleName: string, actionName: string) {\n  const actions = MetaData.actionCreatorMap[moduleName];\n  if (!actions[actionName]) {\n    actions[actionName] = payload => ({type: moduleName + NSP + actionName, payload});\n  }\n}\nexport function injectActions(store: ModelStore, moduleName: string, handlers: ActionHandlerList) {\n  for (const actionNames in handlers) {\n    if (typeof handlers[actionNames] === 'function') {\n      let handler = handlers[actionNames];\n      if (handler.__isReducer__ || handler.__isEffect__) {\n        handler = bindThis(handler, handlers);\n        actionNames.split(',').forEach(actionName => {\n          actionName = actionName.trim().replace(new RegExp(`^this${NSP}`), `${moduleName}${NSP}`);\n          const arr = actionName.split(NSP);\n          if (arr[1]) {\n            handler.__isHandler__ = true;\n            transformAction(actionName, handler, moduleName, handler.__isEffect__ ? store._medux_.effectMap : store._medux_.reducerMap);\n          } else {\n            handler.__isHandler__ = false;\n            transformAction(moduleName + NSP + actionName, handler, moduleName, handler.__isEffect__ ? store._medux_.effectMap : store._medux_.reducerMap);\n            addModuleActionCreatorList(moduleName, actionName);\n          }\n        });\n      }\n    }\n  }\n  return MetaData.actionCreatorMap[moduleName];\n}\n"],"file":"basic.js"}