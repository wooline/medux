{"version":3,"sources":["../../src/store.ts"],"names":["MetaData","NSP","client","isPromise","ActionTypes","errorAction","routeChangeAction","applyMiddleware","compose","createStore","injectModel","isPlainObject","invalidViewTimer","checkInvalidview","currentViews","clientStore","_medux_","views","moduleName","hasOwnProperty","element","viewname","n","Object","keys","length","invalidview","isServer","setTimeout","viewWillMount","viewName","vid","viewWillUnmount","getActionData","action","arr","filter","key","data","bindHistory","store","history","inTimeTravelling","handleLocationChange","location","locationToRouteData","dispatch","subscribe","storeRouteState","getState","route","isTimeTravel","patch","getLocation","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","state","type","F_ROUTE_CHANGE","payload","combineReducers","rootState","meta","prevState","currentState","forEach","handlersCommon","reducerMap","handlersEvery","replace","RegExp","handlers","handlerModules","orderList","priority","fun","appModuleName","unshift","push","__isHandler__","moduleNameMap","changed","some","middlewareEnhancer","preLoadMiddleware","next","split","actionName","moduleGetter","initModel","then","middleware","originalAction","M_LOADING","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","reslove","reject","Promise","all","enhancers","enhancer","newCreateStore","newStore","router","injectedModules","isDev","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","addEventListener","event","reason"],"mappings":"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","sourcesContent":["import {Action, BaseModelState, DisplayViews, MetaData, ModelStore, NSP, RouteData, RouteState, client, isPromise} from './basic';\nimport {ActionTypes, errorAction, routeChangeAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {injectModel} from './module';\nimport {isPlainObject} from './sprite';\n\n/**\n * dispatch push action\n * middleware 拦截并调用history.push\n * history触发侦听器，dispatch change action\n * store侦听器，判断是否时光\n */\n\nlet invalidViewTimer: number;\n\nfunction checkInvalidview() {\n  invalidViewTimer = 0;\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  const views: DisplayViews = {};\n  for (const moduleName in currentViews) {\n    if (currentViews.hasOwnProperty(moduleName)) {\n      const element = currentViews[moduleName];\n      for (const viewname in element) {\n        if (element[viewname]) {\n          const n = Object.keys(element[viewname]).length;\n          if (n) {\n            if (!views[moduleName]) {\n              views[moduleName] = {};\n            }\n            views[moduleName][viewname] = true;\n          }\n        }\n      }\n    }\n  }\n  // MetaData.clientStore.dispatch(viewInvalidAction(views));\n}\n\nexport function invalidview() {\n  if (MetaData.isServer) {\n    return;\n  }\n  if (!invalidViewTimer) {\n    invalidViewTimer = setTimeout(checkInvalidview, 300);\n  }\n}\n\nexport function viewWillMount(moduleName: string, viewName: string, vid: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (!currentViews[moduleName]) {\n    currentViews[moduleName] = {[viewName]: {[vid]: true}};\n  } else {\n    const views = currentViews[moduleName];\n    if (!views[viewName]) {\n      views[viewName] = {[vid]: true};\n    } else {\n      views[viewName][vid] = true;\n    }\n  }\n  invalidview();\n}\n\nexport function viewWillUnmount(moduleName: string, viewName: string, vid: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (currentViews[moduleName] && currentViews[moduleName][viewName]) {\n    const views = currentViews[moduleName][viewName];\n    delete views[vid];\n  }\n  invalidview();\n}\n\n// function excludeDefaultParams(data:any){\n//   return excludeDefaultData(data, MetaData.defaultRouteParams);\n// }\n// function excludeDefaultData(data: any, def: any) {\n//   const result: any = {};\n//   for (const key in data) {\n//     if (data.hasOwnProperty(key)) {\n//       const value = data[key];\n//       const defaultValue = def[key];\n//       if (value !== defaultValue) {\n//         if (typeof value === typeof defaultValue && typeof value === 'object' && !Array.isArray(value)) {\n//           result[key] = excludeDefaultData(value, defaultValue);\n//         } else {\n//           result[key] = value;\n//         }\n//       }\n//     }\n//   }\n//   if (Object.keys(result).length === 0) {\n//     return undefined;\n//   }\n//   return result;\n// }\n\nfunction getActionData(action: Action) {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data;\n  }\n}\nexport interface HistoryProxy<L = any> {\n  getLocation(): L;\n  subscribe(listener: (location: L) => void): void;\n  locationToRouteData(location: L): RouteData;\n  isTimeTravel(storeLocation: L): boolean;\n  patch(location: L, routeData: RouteData): void;\n}\n\nfunction bindHistory<L>(store: ModelStore, history: HistoryProxy<L>) {\n  let inTimeTravelling = false;\n  const handleLocationChange = (location: L) => {\n    if (!inTimeTravelling) {\n      const data = history.locationToRouteData(location);\n      store.dispatch(routeChangeAction({location, data}));\n    } else {\n      inTimeTravelling = false;\n    }\n  };\n  history.subscribe(handleLocationChange);\n  store.subscribe(() => {\n    const storeRouteState: RouteState<L> = store.getState().route;\n    if (history.isTimeTravel(storeRouteState.location)) {\n      inTimeTravelling = true;\n      history.patch(storeRouteState.location, storeRouteState.data);\n    }\n  });\n  handleLocationChange(history.getLocation());\n}\n\nexport function buildStore(\n  history: HistoryProxy<any>,\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = []\n): ModelStore {\n  if (!isPlainObject(preloadedState)) {\n    throw new Error('preloadedState must be plain objects!');\n  }\n  if (!isPlainObject(storeReducers)) {\n    throw new Error('storeReducers must be plain objects!');\n  }\n  if (storeReducers.route) {\n    throw new Error(\"the reducer name 'route' is not allowed\");\n  }\n  storeReducers.route = (state: RouteState, action: Action) => {\n    if (action.type === ActionTypes.F_ROUTE_CHANGE) {\n      const payload: RouteState = getActionData(action);\n      if (!state) {\n        return payload;\n      }\n      return {...state, ...payload};\n    }\n    return state;\n  };\n  let store: ModelStore;\n  const combineReducers = (rootState: {[moduleName: string]: BaseModelState}, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = []; //\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(getActionData(action));\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(NSP)[1] === ActionTypes.M_LOADING) {\n        return originalAction;\n      }\n    }\n    const action: Action = next(originalAction);\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (fun.__isHandler__) {\n          orderList.push(moduleName);\n        } else {\n          orderList.unshift(moduleName);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(getActionData(action));\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (reject: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], reject);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n            }\n          );\n          promiseResults.push(effectResult);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  const preLoadMiddleware = () => (next: Function) => (action: Action) => {\n    const [moduleName, actionName] = action.type.split(NSP);\n    if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n      const initModel = injectModel(MetaData.moduleGetter, moduleName, store);\n      if (isPromise(initModel)) {\n        return initModel.then(() => next(action));\n      }\n    }\n    return next(action);\n  };\n\n  const middlewareEnhancer = applyMiddleware(preLoadMiddleware, ...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._medux_ = {\n        prevState: {router: null},\n        currentState: {router: null},\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  bindHistory(store, history);\n  MetaData.clientStore = store;\n  if (client) {\n    if ('onerror' in client) {\n      client.addEventListener(\n        'error',\n        event => {\n          store.dispatch(errorAction(event));\n        },\n        true\n      );\n    }\n    if ('onunhandledrejection' in client) {\n      client.addEventListener(\n        'unhandledrejection',\n        event => {\n          store.dispatch(errorAction(event.reason));\n        },\n        true\n      );\n    }\n  }\n  return store;\n}\n"],"file":"store.js"}