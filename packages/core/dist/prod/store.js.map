{"version":3,"sources":["../../src/store.ts"],"names":["getActionData","action","arr","Object","keys","filter","key","length","data","bindHistory","store","history","inTimeTravelling","handleLocationChange","location","getState","route","equal","locationToRouteData","dispatch","subscribe","initialized","storeRouteState","getLocation","patch","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","defaultRouteParams","Error","assign","MetaData","state","type","ActionTypes","RouteChange","payload","combineReducers","rootState","meta","_medux_","prevState","currentState","forEach","moduleName","handlersCommon","reducerMap","handlersEvery","replace","RegExp","config","NSP","handlers","handlerModules","orderList","priority","fun","appModuleName","unshift","push","__isHandler__","moduleNameMap","changed","some","middlewareEnhancer","applyMiddleware","preLoadMiddleware","next","split","actionName","moduleGetter","initModel","then","middleware","originalAction","isServer","MLoading","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","errorHandler","reslove","error","Promise","all","enhancers","enhancer","newCreateStore","newStore","injectedModules","currentViews","isDev","client","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","compose","clientStore"],"mappings":"8XAMO,QAASA,CAAAA,aAAT,CAA0BC,CAA1B,CAA6C,CAClD,GAAMC,CAAAA,CAAG,CAAGC,MAAM,CAACC,IAAP,CAAYH,CAAZ,EAAoBI,MAApB,CAA2B,SAAAC,CAAG,QAAY,MAAR,GAAAA,CAAG,EAAuB,UAAR,GAAAA,CAAlB,EAAgD,MAAR,GAAAA,CAA5C,CAA9B,CAAZ,CACA,GAAmB,CAAf,GAAAJ,CAAG,CAACK,MAAR,EAEO,GAAmB,CAAf,GAAAL,CAAG,CAACK,MAAR,CACL,MAAON,CAAAA,CAAM,CAACC,CAAG,CAAC,CAAD,CAAJ,CAAb,CAEA,GAAMM,CAAAA,CAAI,+BAAOP,CAAP,CAAV,CAIA,MAHA,OAAOO,CAAAA,CAAI,KAGX,CAFA,MAAOA,CAAAA,CAAI,SAEX,CADA,MAAOA,CAAAA,CAAI,KACX,CAAOA,CATT,CAWD,CAUD,QAASC,CAAAA,WAAT,CAAwBC,CAAxB,CAA2CC,CAA3C,CAAqE,IAC/DC,CAAAA,CAAgB,GAD+C,CAE7DC,CAAoB,CAAG,SAACC,CAAD,CAAiB,CAC5C,GAAI,CAACF,CAAL,CAAuB,OACLF,CAAK,CAACK,QAAN,EADK,CACdC,CADc,GACdA,KADc,CAErB,GAAIA,CAAJ,EACML,CAAO,CAACM,KAAR,CAAcD,CAAK,CAACF,QAApB,CAA8BA,CAA9B,CADN,CAEI,OAGJ,GAAMN,CAAAA,CAAI,CAAGG,CAAO,CAACO,mBAAR,CAA4BJ,CAA5B,CAAb,CACAJ,CAAK,CAACS,QAAN,CAAe,+BAAkB,CAACL,QAAQ,CAARA,CAAD,CAAWN,IAAI,CAAJA,CAAX,CAAlB,CAAf,CACD,CATD,IAUEI,CAAAA,CAAgB,GAEnB,CAfkE,CAgBnED,CAAO,CAACS,SAAR,CAAkBP,CAAlB,CAhBmE,CAiBnEH,CAAK,CAACU,SAAN,CAAgB,UAAM,CACpB,GAAIT,CAAO,CAACU,WAAZ,CAAyB,CACvB,GAAMC,CAAAA,CAAe,CAAIZ,CAAK,CAACK,QAAN,EAAD,CAAiCC,KAAzD,CACKL,CAAO,CAACM,KAAR,CAAcK,CAAe,CAACR,QAA9B,CAAwCH,CAAO,CAACY,WAAR,EAAxC,CAFkB,GAGrBX,CAAgB,GAHK,CAIrBD,CAAO,CAACa,KAAR,CAAcF,CAAe,CAACR,QAA9B,CAAwCQ,CAAe,CAACd,IAAxD,CAJqB,CAMxB,CACF,CARD,CAjBmE,CA0BnEG,CAAO,CAACU,WAAR,EAAuBR,CAAoB,CAACF,CAAO,CAACY,WAAR,EAAD,CAC5C,CAEM,QAASE,CAAAA,UAAT,CACLd,CADK,CAELe,CAFK,CAGLC,CAHK,CAILC,CAJK,CAKLC,CALK,CAMLC,CANK,CAOO,CACZ,YANAJ,CAMA,GANAA,CAMA,CANuC,EAMvC,WALAC,CAKA,GALAA,CAKA,CAL6C,EAK7C,WAJAC,CAIA,GAJAA,CAIA,CAJiC,EAIjC,WAHAC,CAGA,GAHAA,CAGA,CAHkC,EAGlC,WAFAC,CAEA,GAFAA,CAEA,CAF+E,EAE/E,EAAIH,CAAa,CAACX,KAAlB,CACE,KAAM,IAAIe,CAAAA,KAAJ,CAAU,yCAAV,CAAN,CAEF5B,MAAM,CAAC6B,MAAP,CAAcC,gBAASH,kBAAvB,CAA2CA,CAA3C,CAJY,CAKZH,CAAa,CAACX,KAAd,CAAsB,SAACkB,CAAD,CAAoBjC,CAApB,CAAuC,CAC3D,GAAIA,CAAM,CAACkC,IAAP,GAAgBC,qBAAYC,WAAhC,CAA6C,CAC3C,GAAMC,CAAAA,CAAmB,CAAGtC,aAAa,CAACC,CAAD,CAAzC,CAD2C,MAEtCiC,CAAAA,CAFsC,+BAKhCA,CALgC,CAKtBI,CALsB,EAGlCA,CAGV,CACD,MAAOJ,CAAAA,CACR,CAdW,IAeRxB,CAAAA,CAfQ,CAgBN6B,CAAe,CAAG,SAACC,CAAD,CAAwBvC,CAAxB,CAA2C,CACjE,GAAI,CAACS,CAAL,CACE,MAAO8B,CAAAA,CAAP,CAEF,GAAMC,CAAAA,CAAI,CAAG/B,CAAK,CAACgC,OAAnB,CACAD,CAAI,CAACE,SAAL,CAAiBH,CALgD,CAMjE,GAAMI,CAAAA,CAAY,+BAAOJ,CAAP,CAAlB,CACAC,CAAI,CAACG,YAAL,CAAoBA,CAP6C,CAQjEzC,MAAM,CAACC,IAAP,CAAYuB,CAAZ,EAA2BkB,OAA3B,CAAmC,SAAAC,CAAU,CAAI,CAC/CF,CAAY,CAACE,CAAD,CAAZ,CAA2BnB,CAAa,CAACmB,CAAD,CAAb,CAA0BF,CAAY,CAACE,CAAD,CAAtC,CAAoD7C,CAApD,CAC5B,CAFD,CARiE,IAW3D8C,CAAAA,CAAc,CAAGN,CAAI,CAACO,UAAL,CAAgB/C,CAAM,CAACkC,IAAvB,GAAgC,EAXU,CAa3Dc,CAAa,CAAGR,CAAI,CAACO,UAAL,CAAgB/C,CAAM,CAACkC,IAAP,CAAYe,OAAZ,CAAoB,GAAIC,CAAAA,MAAJ,MAAgBC,cAAOC,GAAvB,MAApB,CAAqD,GAArD,CAAhB,GAA8E,EAbnC,CAc3DC,CAAQ,+BAAOP,CAAP,CAA0BE,CAA1B,CAdmD,CAe3DM,CAAc,CAAGpD,MAAM,CAACC,IAAP,CAAYkD,CAAZ,CAf0C,CAYjE;AAKA,GAA4B,CAAxB,CAAAC,CAAc,CAAChD,MAAnB,CAA+B,IACvBiD,CAAAA,CAAmB,CAAG,EADC,CAEvBC,CAAkB,CAAGxD,CAAM,CAACwD,QAAP,WAAsBxD,CAAM,CAACwD,QAA7B,EAAyC,EAFvC,CAG7BF,CAAc,CAACV,OAAf,CAAuB,SAAAC,CAAU,CAAI,CACnC,GAAMY,CAAAA,CAAG,CAAGJ,CAAQ,CAACR,CAAD,CAApB,CACIA,CAAU,GAAKb,gBAAS0B,aAFO,CAGjCH,CAAS,CAACI,OAAV,CAAkBd,CAAlB,CAHiC,CAKjCU,CAAS,CAACK,IAAV,CAAef,CAAf,CALiC,CAO9BY,CAAG,CAACI,aAP0B,EAQjCL,CAAQ,CAACG,OAAT,CAAiBd,CAAjB,CAEH,CAVD,CAH6B,CAc7BU,CAAS,CAACI,OAAV,OAAAJ,CAAS,CAAYC,CAAZ,CAdoB,CAe7B,GAAMM,CAAAA,CAAuC,CAAG,EAAhD,CACAP,CAAS,CAACX,OAAV,CAAkB,SAAAC,CAAU,CAAI,CAC9B,GAAI,CAACiB,CAAa,CAACjB,CAAD,CAAlB,CAAgC,CAC9BiB,CAAa,CAACjB,CAAD,CAAb,GAD8B,CAE9B,GAAMY,CAAAA,CAAG,CAAGJ,CAAQ,CAACR,CAAD,CAApB,CACAF,CAAY,CAACE,CAAD,CAAZ,CAA2BY,CAAG,CAAC1D,aAAa,CAACC,CAAD,CAAd,CAC/B,CACF,CAND,CAOD,CACD,GAAM+D,CAAAA,CAAO,CAAG7D,MAAM,CAACC,IAAP,CAAYoC,CAAZ,EAAuBjC,MAAvB,GAAkCJ,MAAM,CAACC,IAAP,CAAYwC,CAAZ,EAA0BrC,MAA5D,EAAsEJ,MAAM,CAACC,IAAP,CAAYoC,CAAZ,EAAuByB,IAAvB,CAA4B,SAAAnB,CAAU,QAAIN,CAAAA,CAAS,CAACM,CAAD,CAAT,GAA0BF,CAAY,CAACE,CAAD,CAA1C,CAAtC,CAAtF,CAEA,MADAL,CAAAA,CAAI,CAACE,SAAL,CAAiBqB,CAAO,CAAGpB,CAAH,CAAkBJ,CAC1C,CAAOC,CAAI,CAACE,SACb,CA5DW,CAkKNuB,CAAkB,CAAGC,qCAXD,QAApBC,CAAAA,iBAAoB,SAAM,UAACC,CAAD,QAAoB,UAACpE,CAAD,CAAoB,OACrCA,CAAM,CAACkC,IAAP,CAAYmC,KAAZ,CAAkBlB,cAAOC,GAAzB,CADqC,CAC/DP,CAD+D,MACnDyB,CADmD,MAEtE,GAAIzB,CAAU,EAAIyB,CAAd,EAA4BtC,gBAASuC,YAAT,CAAsB1B,CAAtB,CAAhC,CAAmE,CACjE,GAAM2B,CAAAA,CAAS,CAAG,wBAAYxC,gBAASuC,YAArB,CAAmC1B,CAAnC,CAA+CpC,CAA/C,CAAlB,CACA,GAAI,qBAAU+D,CAAV,CAAJ,CACE,MAAOA,CAAAA,CAAS,CAACC,IAAV,CAAe,iBAAML,CAAAA,CAAI,CAACpE,CAAD,CAAV,CAAf,CAEV,CACD,MAAOoE,CAAAA,CAAI,CAACpE,CAAD,CACZ,CAT+B,CAAN,CAWC,SAAsC2B,CAAtC,EArGR,QAAb+C,CAAAA,UAAa,SAAM,UAACN,CAAD,QAAoB,UAACO,CAAD,CAA4B,CACvE,GAAI3C,gBAAS4C,QAAb,EACMD,CAAc,CAACzC,IAAf,CAAoBmC,KAApB,CAA0BlB,cAAOC,GAAjC,EAAsC,CAAtC,IAA6CjB,qBAAY0C,QAD/D,CAEI,MAAOF,CAAAA,CAAP,CAHmE,GAMjE3E,CAAAA,CAAc,CAAGoE,CAAI,CAACO,CAAD,CAN4C,CAOjE7B,CAAc,CAAGrC,CAAK,CAACgC,OAAN,CAAcqC,SAAd,CAAwB9E,CAAM,CAACkC,IAA/B,GAAwC,EAPQ,CASjEc,CAAa,CAAGvC,CAAK,CAACgC,OAAN,CAAcqC,SAAd,CAAwB9E,CAAM,CAACkC,IAAP,CAAYe,OAAZ,CAAoB,GAAIC,CAAAA,MAAJ,MAAgBC,cAAOC,GAAvB,MAApB,CAAqD,GAArD,CAAxB,GAAsF,EATrC,CAUjEC,CAAQ,+BAAOP,CAAP,CAA0BE,CAA1B,CAVyD,CAWjEM,CAAc,CAAGpD,MAAM,CAACC,IAAP,CAAYkD,CAAZ,CAXgD,CAavE,GAA4B,CAAxB,CAAAC,CAAc,CAAChD,MAAnB,CAA+B,IACvBiD,CAAAA,CAAmB,CAAG,EADC,CAEvBC,CAAkB,CAAGxD,CAAM,CAACwD,QAAP,WAAsBxD,CAAM,CAACwD,QAA7B,EAAyC,EAFvC,CAG7BF,CAAc,CAACV,OAAf,CAAuB,SAAAC,CAAU,CAAI,CACnC,GAAMY,CAAAA,CAAG,CAAGJ,CAAQ,CAACR,CAAD,CAApB,CACIA,CAAU,GAAKb,gBAAS0B,aAFO,CAGjCH,CAAS,CAACI,OAAV,CAAkBd,CAAlB,CAHiC,CAKjCU,CAAS,CAACK,IAAV,CAAef,CAAf,CALiC,CAO9BY,CAAG,CAACI,aAP0B,EAQjCL,CAAQ,CAACG,OAAT,CAAiBd,CAAjB,CAEH,CAVD,CAH6B,CAc7BU,CAAS,CAACI,OAAV,OAAAJ,CAAS,CAAYC,CAAZ,CAdoB,IAevBM,CAAAA,CAAuC,CAAG,EAfnB,CAgBvBiB,CAA8B,CAAG,EAhBV,CAsE7B,GArDAxB,CAAS,CAACX,OAAV,CAAkB,SAAAC,CAAU,CAAI,CAC9B,GAAI,CAACiB,CAAa,CAACjB,CAAD,CAAlB,CAAgC,CAC9BiB,CAAa,CAACjB,CAAD,CAAb,GAD8B,IAExBY,CAAAA,CAAG,CAAGJ,CAAQ,CAACR,CAAD,CAFU,CAGxBmC,CAAY,CAAGvB,CAAG,CAAC1D,aAAa,CAACC,CAAD,CAAd,CAHM,CAIxBiF,CAAU,CAAGxB,CAAG,CAACyB,cAJO,CAK9B,GAAID,CAAJ,CAAgB,CACd,GAAME,CAAAA,CAAc,CAAG,EAAvB,CACAF,CAAU,CAACrC,OAAX,CAAmB,SAACwC,CAAD,CAAYC,CAAZ,CAAsB,CACvCF,CAAO,CAACE,CAAD,CAAP,CAAiBD,CAAS,CAAC,CAAD,CAAT,CAAapF,CAAb,CAAqB6C,CAArB,CAAiCmC,CAAjC,CAClB,CAFD,CAFc,CAKdvB,CAAG,CAAC6B,oBAAJ,CAA2BH,CAC5B,CAED,GAAMI,CAAAA,CAAY,CAAGP,CAAY,CAACP,IAAb,CACnB,SAACe,CAAD,CAAkB,CAChB,GAAIP,CAAJ,CAAgB,CACd,GAAME,CAAAA,CAAO,CAAG1B,CAAG,CAAC6B,oBAAJ,EAA4B,EAA5C,CACAL,CAAU,CAACrC,OAAX,CAAmB,SAACwC,CAAD,CAAYC,CAAZ,CAAsB,CACnCD,CAAS,CAAC,CAAD,CAD0B,EAErCA,CAAS,CAAC,CAAD,CAAT,CAAa,UAAb,CAAyBD,CAAO,CAACE,CAAD,CAAhC,CAAyCG,CAAzC,CAEH,CAJD,CAFc,CAOd/B,CAAG,CAAC6B,oBAAJ,OACD,CACD,MAAOE,CAAAA,CACR,CAZkB,CAanB,SAACC,CAAD,CAAgB,CACd,GAAIR,CAAJ,CAAgB,CACd,GAAME,CAAAA,CAAO,CAAG1B,CAAG,CAAC6B,oBAAJ,EAA4B,EAA5C,CACAL,CAAU,CAACrC,OAAX,CAAmB,SAACwC,CAAD,CAAYC,CAAZ,CAAsB,CACnCD,CAAS,CAAC,CAAD,CAD0B,EAErCA,CAAS,CAAC,CAAD,CAAT,CAAa,UAAb,CAAyBD,CAAO,CAACE,CAAD,CAAhC,CAAyCI,CAAzC,CAEH,CAJD,CAFc,CAOdhC,CAAG,CAAC6B,oBAAJ,OACD,CACD,GAAItF,CAAM,CAACkC,IAAP,GAAgBC,qBAAYL,KAAhC,CAIE,KAHI,sCAAiB2D,CAAjB,CAGJ,GAFEA,CAAK,CAAG,6BAAkBA,CAAlB,IAEV,EAAMA,CAAN,CAJF,IAKO,IAAI,4BAAiBA,CAAjB,CAAJ,CACL,KAAMA,CAAAA,CAAN,CADK,IAGL,OAAOhF,CAAAA,CAAK,CAACS,QAAN,CAAe,yBAAYuE,CAAZ,CAAf,CAEV,CAjCkB,CAArB,CAoCAV,CAAc,CAACnB,IAAf,CAAoB2B,CAApB,CACD,CACF,CApDD,CAqDA,CAAIR,CAAc,CAACzE,MAAnB,CACE,MAAOoF,CAAAA,OAAO,CAACC,GAAR,CAAYZ,CAAZ,CAEV,CACD,MAAO/E,CAAAA,CACR,CAxFwB,CAAN,CAqGQ,GAlKf,CAkLN4F,CAAS,WAAOhE,CAAP,EAAuBqC,CAAvB,CAfiB,QAA1B4B,CAAAA,QAA0B,CAAAC,CAAc,CAAI,CAChD,MAAO,WAAa,IACZC,CAAAA,CAAQ,CAAGD,CAAc,MAAd,kBADC,CAWlB,MAT+BC,CAAAA,CAC/B,CAAWtD,OAAX,CAAqB,CACnBC,SAAS,CAAE,EADQ,CAEnBC,YAAY,CAAE,EAFK,CAGnBI,UAAU,CAAE,EAHO,CAInB+B,SAAS,CAAE,EAJQ,CAKnBkB,eAAe,CAAE,EALE,CAMnBC,YAAY,CAAE,EANK,CAQrB,CAAOF,CACR,CACF,CACc,EAlLH,CAyLZ,MANI/D,iBAASkE,KAAT,EAAkBC,aAAlB,EAA4BA,cAAOC,4BAMvC,EALER,CAAS,CAAChC,IAAV,CAAeuC,cAAOC,4BAAP,CAAoCD,cAAOE,mCAA3C,CAAf,CAKF,CAHA5F,CAAK,CAAG,uBAAY6B,CAAZ,CAAoCb,CAApC,CAAoD6E,4BAAWV,CAAX,CAApD,CAGR,CAFApF,WAAW,CAACC,CAAD,CAAQC,CAAR,CAEX,CADAsB,gBAASuE,WAAT,CAAuB9F,CACvB,CAAOA,CACR","sourcesContent":["import {Action, MetaData, ModelStore, RouteData, RouteState, StoreState, client, config, isProcessedError, isPromise, setProcessedError} from './basic';\nimport {ActionTypes, errorAction, routeChangeAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {injectModel} from './module';\n\nexport function getActionData<T>(action: Action): T {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined as any;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data as any;\n  }\n}\nexport interface HistoryProxy<L = any> {\n  initialized: boolean;\n  getLocation(): L;\n  subscribe(listener: (location: L) => void): void;\n  locationToRouteData(location: L): RouteData;\n  equal(a: L, b: L): boolean;\n  patch(location: L, routeData: RouteData): void;\n}\n\nfunction bindHistory<L>(store: ModelStore, history: HistoryProxy<L>) {\n  let inTimeTravelling = false;\n  const handleLocationChange = (location: L) => {\n    if (!inTimeTravelling) {\n      const {route} = store.getState() as StoreState;\n      if (route) {\n        if (history.equal(route.location, location)) {\n          return;\n        }\n      }\n      const data = history.locationToRouteData(location);\n      store.dispatch(routeChangeAction({location, data}));\n    } else {\n      inTimeTravelling = false;\n    }\n  };\n  history.subscribe(handleLocationChange);\n  store.subscribe(() => {\n    if (history.initialized) {\n      const storeRouteState = (store.getState() as StoreState).route;\n      if (!history.equal(storeRouteState.location, history.getLocation())) {\n        inTimeTravelling = true;\n        history.patch(storeRouteState.location, storeRouteState.data);\n      }\n    }\n  });\n  history.initialized && handleLocationChange(history.getLocation());\n}\n\nexport function buildStore(\n  history: HistoryProxy<any>,\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = [],\n  defaultRouteParams: {[moduleName: string]: {[key: string]: any} | undefined} = {}\n): ModelStore {\n  if (storeReducers.route) {\n    throw new Error(\"the reducer name 'route' is not allowed\");\n  }\n  Object.assign(MetaData.defaultRouteParams, defaultRouteParams);\n  storeReducers.route = (state: RouteState, action: Action) => {\n    if (action.type === ActionTypes.RouteChange) {\n      const payload: RouteState = getActionData(action);\n      if (!state) {\n        return payload;\n      }\n      return {...state, ...payload};\n    }\n    return state;\n  };\n  let store: ModelStore;\n  const combineReducers = (rootState: StoreState, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${config.NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = [];\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(getActionData(action));\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(config.NSP)[1] === ActionTypes.MLoading) {\n        return originalAction;\n      }\n    }\n    const action: Action = next(originalAction);\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${config.NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = [];\n      const priority: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (moduleName === MetaData.appModuleName) {\n          orderList.unshift(moduleName);\n        } else {\n          orderList.push(moduleName);\n        }\n        if (!fun.__isHandler__) {\n          priority.unshift(moduleName);\n        }\n      });\n      orderList.unshift(...priority);\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(getActionData(action));\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          const errorHandler = effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (error: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], error);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              if (action.type === ActionTypes.Error) {\n                if (isProcessedError(error) === undefined) {\n                  error = setProcessedError(error, true);\n                }\n                throw error;\n              } else if (isProcessedError(error)) {\n                throw error;\n              } else {\n                return store.dispatch(errorAction(error)) as any;\n              }\n            }\n          );\n\n          promiseResults.push(errorHandler);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  const preLoadMiddleware = () => (next: Function) => (action: Action) => {\n    const [moduleName, actionName] = action.type.split(config.NSP);\n    if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n      const initModel = injectModel(MetaData.moduleGetter, moduleName, store);\n      if (isPromise(initModel)) {\n        return initModel.then(() => next(action));\n      }\n    }\n    return next(action);\n  };\n\n  const middlewareEnhancer = applyMiddleware(preLoadMiddleware, ...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._medux_ = {\n        prevState: {} as any,\n        currentState: {} as any,\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  bindHistory(store, history);\n  MetaData.clientStore = store;\n  return store;\n}\n"],"file":"store.js"}