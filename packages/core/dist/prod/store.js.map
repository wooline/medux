{"version":3,"sources":["../../src/store.ts"],"names":["MetaData","NSP","client","isPromise","ActionTypes","errorAction","viewInvalidAction","applyMiddleware","compose","createStore","injectModel","isPlainObject","invalidViewTimer","checkInvalidview","currentViews","clientStore","_medux_","views","moduleName","hasOwnProperty","element","viewname","dispatch","invalidview","isServer","setTimeout","viewWillMount","viewName","viewWillUnmount","getActionData","action","arr","Object","keys","filter","key","length","data","simpleEqual","obj1","obj2","keys1","keys2","buildStore","preloadedState","storeReducers","storeMiddlewares","storeEnhancers","Error","store","combineReducers","rootState","meta","prevState","currentState","forEach","type","F_VIEW_INVALID","handlersCommon","reducerMap","handlersEvery","replace","RegExp","handlers","handlerModules","orderList","priority","fun","__isHandler__","push","unshift","moduleNameMap","changed","some","middlewareEnhancer","preLoadMiddleware","next","split","actionName","moduleGetter","initModel","then","middleware","originalAction","M_LOADING","effectMap","promiseResults","effectResult","decorators","__decorators__","results","decorator","index","__decoratorResults__","reslove","reject","Promise","all","enhancers","enhancer","newCreateStore","newStore","router","injectedModules","isDev","__REDUX_DEVTOOLS_EXTENSION__","__REDUX_DEVTOOLS_EXTENSION__OPTIONS","addEventListener","event","reason"],"mappings":"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","sourcesContent":["import {Action, CurrentViews, MetaData, ModelStore, NSP, client, isPromise} from './basic';\nimport {ActionTypes, errorAction, viewInvalidAction} from './actions';\nimport {Middleware, ReducersMapObject, StoreEnhancer, applyMiddleware, compose, createStore} from 'redux';\n\nimport {injectModel} from './module';\nimport {isPlainObject} from './sprite';\n\nlet invalidViewTimer: number;\n\nfunction checkInvalidview() {\n  invalidViewTimer = 0;\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  const views: CurrentViews = {};\n  for (const moduleName in currentViews) {\n    if (currentViews.hasOwnProperty(moduleName)) {\n      const element = currentViews[moduleName];\n      for (const viewname in element) {\n        if (element[viewname]) {\n          views[moduleName][viewname] = true;\n        }\n      }\n    }\n  }\n  MetaData.clientStore.dispatch(viewInvalidAction(views));\n}\n\nexport function invalidview() {\n  if (MetaData.isServer) {\n    return;\n  }\n  if (!invalidViewTimer) {\n    invalidViewTimer = setTimeout(checkInvalidview, 300);\n  }\n}\n\nexport function viewWillMount(moduleName: string, viewName: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (!currentViews[moduleName]) {\n    currentViews[moduleName] = {[viewName]: true};\n  } else {\n    currentViews[moduleName][viewName] = true;\n  }\n  invalidview();\n}\n\nexport function viewWillUnmount(moduleName: string, viewName: string) {\n  if (MetaData.isServer) {\n    return;\n  }\n  const currentViews = MetaData.clientStore._medux_.currentViews;\n  if (currentViews[moduleName] && currentViews[moduleName][viewName]) {\n    delete currentViews[moduleName][viewName];\n  }\n  invalidview();\n}\nfunction getActionData(action: Action) {\n  const arr = Object.keys(action).filter(key => key !== 'type' && key !== 'priority' && key !== 'time');\n  if (arr.length === 0) {\n    return undefined;\n  } else if (arr.length === 1) {\n    return action[arr[0]];\n  } else {\n    const data = {...action};\n    delete data['type'];\n    delete data['priority'];\n    delete data['time'];\n    return data;\n  }\n}\n\nfunction simpleEqual(obj1: any, obj2: any): boolean {\n  if (obj1 === obj2) {\n    return true;\n  } else if (typeof obj1 !== typeof obj2 || typeof obj1 !== 'object') {\n    return false;\n  } else {\n    const keys1 = Object.keys(obj1);\n    const keys2 = Object.keys(obj2);\n    if (keys1.length !== keys2.length) {\n      return false;\n    } else {\n      for (const key of keys1) {\n        if (!simpleEqual(obj1[key], obj2[key])) {\n          return false;\n        }\n      }\n      return true;\n    }\n  }\n}\n\nexport function buildStore(\n  preloadedState: {[key: string]: any} = {},\n  storeReducers: ReducersMapObject<any, any> = {},\n  storeMiddlewares: Middleware[] = [],\n  storeEnhancers: StoreEnhancer[] = []\n): ModelStore {\n  if (!isPlainObject(preloadedState)) {\n    throw new Error('preloadedState must be plain objects!');\n  }\n  if (!isPlainObject(storeReducers)) {\n    throw new Error('storeReducers must be plain objects!');\n  }\n  let store: ModelStore;\n  const combineReducers = (rootState: {[key: string]: any}, action: Action) => {\n    if (!store) {\n      return rootState;\n    }\n    const meta = store._medux_;\n    meta.prevState = rootState;\n    const currentState = {...rootState};\n    meta.currentState = currentState;\n\n    if (!currentState.views) {\n      currentState.views = {};\n    }\n    Object.keys(storeReducers).forEach(moduleName => {\n      currentState[moduleName] = storeReducers[moduleName](currentState[moduleName], action);\n    });\n    if (action.type === ActionTypes.F_VIEW_INVALID) {\n      const views: CurrentViews = getActionData(action);\n      if (!simpleEqual(currentState.views, views)) {\n        currentState.views = views;\n      }\n    }\n    const handlersCommon = meta.reducerMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = meta.reducerMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (fun.__isHandler__) {\n          orderList.push(moduleName);\n        } else {\n          orderList.unshift(moduleName);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          currentState[moduleName] = fun(getActionData(action));\n        }\n      });\n    }\n    const changed = Object.keys(rootState).length !== Object.keys(currentState).length || Object.keys(rootState).some(moduleName => rootState[moduleName] !== currentState[moduleName]);\n    meta.prevState = changed ? currentState : rootState;\n    return meta.prevState;\n  };\n\n  const middleware = () => (next: Function) => (originalAction: Action) => {\n    if (MetaData.isServer) {\n      if (originalAction.type.split(NSP)[1] === ActionTypes.M_LOADING) {\n        return originalAction;\n      }\n    }\n    const action: Action = next(originalAction);\n    const handlersCommon = store._medux_.effectMap[action.type] || {};\n    // 支持泛监听，形如 */loading\n    const handlersEvery = store._medux_.effectMap[action.type.replace(new RegExp(`[^${NSP}]+`), '*')] || {};\n    const handlers = {...handlersCommon, ...handlersEvery};\n    const handlerModules = Object.keys(handlers);\n\n    if (handlerModules.length > 0) {\n      const orderList: string[] = action.priority ? [...action.priority] : [];\n      handlerModules.forEach(moduleName => {\n        const fun = handlers[moduleName];\n        if (fun.__isHandler__) {\n          orderList.push(moduleName);\n        } else {\n          orderList.unshift(moduleName);\n        }\n      });\n      const moduleNameMap: {[key: string]: boolean} = {};\n      const promiseResults: Promise<any>[] = [];\n      orderList.forEach(moduleName => {\n        if (!moduleNameMap[moduleName]) {\n          moduleNameMap[moduleName] = true;\n          const fun = handlers[moduleName];\n          const effectResult = fun(getActionData(action));\n          const decorators = fun.__decorators__;\n          if (decorators) {\n            const results: any[] = [];\n            decorators.forEach((decorator, index) => {\n              results[index] = decorator[0](action, moduleName, effectResult);\n            });\n            fun.__decoratorResults__ = results;\n          }\n\n          effectResult.then(\n            (reslove: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Resolved', results[index], reslove);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n              return reslove;\n            },\n            (reject: any) => {\n              if (decorators) {\n                const results = fun.__decoratorResults__ || [];\n                decorators.forEach((decorator, index) => {\n                  if (decorator[1]) {\n                    decorator[1]('Rejected', results[index], reject);\n                  }\n                });\n                fun.__decoratorResults__ = undefined;\n              }\n            }\n          );\n          promiseResults.push(effectResult);\n        }\n      });\n      if (promiseResults.length) {\n        return Promise.all(promiseResults);\n      }\n    }\n    return action;\n  };\n\n  const preLoadMiddleware = () => (next: Function) => (action: Action) => {\n    const [moduleName, actionName] = action.type.split(NSP);\n    if (moduleName && actionName && MetaData.moduleGetter[moduleName]) {\n      const initModel = injectModel(MetaData.moduleGetter, moduleName, store);\n      if (isPromise(initModel)) {\n        return initModel.then(() => next(action));\n      }\n    }\n    return next(action);\n  };\n  const middlewareEnhancer = applyMiddleware(preLoadMiddleware, ...storeMiddlewares, middleware);\n  const enhancer: StoreEnhancer = newCreateStore => {\n    return (...args) => {\n      const newStore = newCreateStore(...args);\n      const modelStore: ModelStore = newStore as any;\n      modelStore._medux_ = {\n        prevState: {router: null},\n        currentState: {router: null},\n        reducerMap: {},\n        effectMap: {},\n        injectedModules: {},\n        currentViews: {},\n      };\n      return newStore;\n    };\n  };\n  const enhancers = [...storeEnhancers, middlewareEnhancer, enhancer];\n  if (MetaData.isDev && client && client.__REDUX_DEVTOOLS_EXTENSION__) {\n    enhancers.push(client.__REDUX_DEVTOOLS_EXTENSION__(client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS));\n  }\n  store = createStore(combineReducers as any, preloadedState, compose(...enhancers));\n  MetaData.clientStore = store;\n  if (client) {\n    if ('onerror' in client) {\n      client.addEventListener(\n        'error',\n        event => {\n          store.dispatch(errorAction(event));\n        },\n        true\n      );\n    }\n    if ('onunhandledrejection' in client) {\n      client.addEventListener(\n        'unhandledrejection',\n        event => {\n          store.dispatch(errorAction(event.reason));\n        },\n        true\n      );\n    }\n  }\n  return store;\n}\n"],"file":"store.js"}