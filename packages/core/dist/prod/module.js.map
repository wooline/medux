{"version":3,"sources":["../../src/module.ts"],"names":["exportModule","moduleName","initState","ActionHandles","views","defaultRouteParams","routeParams","model","store","hasInjected","_medux_","injectedModules","moduleState","getState","handlers","actions","params","prevState","route","data","initAction","Init","dispatch","BaseModelHandlers","isModule","getRootState","getCurrentState","currentState","getCurrentRootState","action","handler","MetaData","actionCreatorMap","__actionName__","payload","callThisAction","Update","reducer","state","loading","isPromiseModule","module","isPromiseView","moduleView","exportActions","moduleGetter","Object","keys","reduce","maps","Proxy","get","target","key","type","config","NSP","set","injectModel","result","then","default","getView","viewName","view","isServer","initModel","clientStore","getModuleByName","getModuleListByNames","moduleNames","preModules","map","Promise","resolve","all","renderApp","render","appModuleName","history","storeOptions","ssrInitStoreKey","initData","client","reducers","middlewares","enhancers","preModuleNames","push","filter","appModule","renderSSR","storeState","paths","length","inited","i","k","split","VSP"],"mappings":"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","sourcesContent":["import {Action, ActionCreatorList, ActionHandler, BaseModelState, MetaData, ModelStore, StoreState, client, config, defaultRouteParams, injectActions, isPromise, reducer} from './basic';\nimport {HistoryProxy, buildStore} from './store';\nimport {Middleware, ReducersMapObject, Store, StoreEnhancer} from 'redux';\n\nexport interface Model<ModelState extends BaseModelState = BaseModelState> {\n  moduleName: string;\n  initState: ModelState;\n  (store: ModelStore): void | Promise<void>;\n}\n\nexport interface Module<M extends Model = Model, VS extends {[key: string]: any} = {[key: string]: any}, AS extends ActionCreatorList = {}, N extends string = string> {\n  default: {\n    moduleName: N;\n    model: M;\n    views: VS;\n    actions: AS;\n  };\n}\n\nexport interface ModuleGetter {\n  [moduleName: string]: () => Module | Promise<Module>;\n}\n\ntype ReturnModule<T> = T extends () => Promise<infer R> ? R : T extends () => infer R ? R : never;\n// export type ReturnViews<T extends () => any> = T extends () => Promise<Module<Model, infer R>> ? R : T extends () => Module<Model, infer R> ? R : never;\ntype ModuleName<M extends any> = M['default']['moduleName'];\ntype ModuleStates<M extends any> = M['default']['model']['initState'];\ntype ModuleParams<M extends any> = M['default']['model']['initState']['routeParams'];\ntype ModuleViews<M extends any> = M['default']['views'];\ntype ModuleActions<M extends any> = M['default']['actions'];\ntype MountViews<M extends any> = {[key in keyof M['default']['views']]?: boolean};\n\nexport type RootState<G extends ModuleGetter, L> = {\n  route: {\n    location: L;\n    data: {\n      views: {[key in keyof G]?: MountViews<ReturnModule<G[key]>>};\n      params: {[key in keyof G]?: ModuleParams<ReturnModule<G[key]>>};\n      stackParams: ({[moduleName: string]: {[key: string]: any} | undefined} | undefined)[];\n      paths: any;\n    };\n  };\n} & {[key in keyof G]?: ModuleStates<ReturnModule<G[key]>>};\n\nexport type ExportModule<Component> = <S extends BaseModelState, V extends {[key: string]: Component}, T extends BaseModelHandlers<S, any>, N extends string>(\n  moduleName: N,\n  initState: S,\n  ActionHandles: {new (moduleName: string, store: any, initState: any, presetData?: any): T},\n  views: V\n) => Module<Model<S>, V, Actions<T>, N>['default'];\n\nexport const exportModule: ExportModule<any> = (moduleName, initState, ActionHandles, views) => {\n  if (!defaultRouteParams[moduleName]) {\n    defaultRouteParams[moduleName] = initState.routeParams;\n  }\n  const model = (store: ModelStore) => {\n    const hasInjected = store._medux_.injectedModules[moduleName];\n    if (!hasInjected) {\n      store._medux_.injectedModules[moduleName] = true;\n      const moduleState: BaseModelState = store.getState()[moduleName];\n      const handlers = new ActionHandles(moduleName, store, initState, moduleState);\n      const actions = injectActions(store, moduleName, handlers as any);\n      (handlers as any).actions = actions;\n      if (!moduleState) {\n        const params = store._medux_.prevState.route.data.params || {};\n        const initAction = actions.Init({...initState, routeParams: params[moduleName] || defaultRouteParams[moduleName]});\n        return store.dispatch(initAction) as any;\n      }\n    }\n    return void 0;\n  };\n  model.moduleName = moduleName;\n  model.initState = initState;\n  const actions = {} as any;\n  return {\n    moduleName,\n    model,\n    views,\n    actions,\n  };\n};\n\nexport abstract class BaseModelHandlers<S extends BaseModelState, R> {\n  protected readonly actions: Actions<this> = null as any;\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  public constructor(protected readonly moduleName: string, protected readonly store: ModelStore, protected readonly initState: S, presetData?: any) {\n    initState.isModule = true;\n  }\n\n  protected get state(): S {\n    return this.getState();\n  }\n  //ie8不支持getter\n  protected getState(): S {\n    return this.store._medux_.prevState[this.moduleName] as S;\n  }\n  protected get rootState(): R {\n    return this.getRootState();\n  }\n  //ie8不支持getter\n  protected getRootState(): R {\n    return this.store._medux_.prevState as any;\n  }\n  protected get currentState(): S {\n    return this.getCurrentState();\n  }\n  //ie8不支持getter\n  protected getCurrentState(): S {\n    return this.store._medux_.currentState[this.moduleName] as S;\n  }\n  protected get currentRootState(): R {\n    return this.getCurrentRootState();\n  }\n  //ie8不支持getter\n  protected getCurrentRootState(): R {\n    return this.store._medux_.currentState as any;\n  }\n  protected dispatch(action: Action): Action | Promise<void> {\n    return this.store.dispatch(action) as any;\n  }\n\n  protected callThisAction<T extends any[]>(handler: (...args: T) => any, ...rest: T): {type: string; payload?: any} {\n    const actions = MetaData.actionCreatorMap[this.moduleName];\n    return actions[(handler as ActionHandler).__actionName__](rest[0]);\n  }\n  protected updateState(payload: Partial<S>) {\n    this.dispatch(this.callThisAction(this.Update, {...this.getState(), ...payload}));\n  }\n\n  @reducer\n  protected Init(payload: S): S {\n    return payload;\n  }\n\n  @reducer\n  protected Update(payload: S): S {\n    return payload;\n  }\n\n  @reducer\n  protected Loading(payload: {[group: string]: string}): S {\n    const state = this.getState();\n    if (!state) {\n      return state;\n    }\n    return {\n      ...state,\n      loading: {...state.loading, ...payload},\n    };\n  }\n}\n\ntype Handler<F> = F extends (...args: infer P) => any\n  ? (\n      ...args: P\n    ) => {\n      type: string;\n    }\n  : never;\n\nexport type Actions<Ins> = {[K in keyof Ins]: Ins[K] extends (...args: any[]) => any ? Handler<Ins[K]> : never};\n\nexport function isPromiseModule(module: Module | Promise<Module>): module is Promise<Module> {\n  return typeof module['then'] === 'function';\n}\nexport function isPromiseView<T>(moduleView: T | Promise<T>): moduleView is Promise<T> {\n  return typeof moduleView['then'] === 'function';\n}\n\nexport function exportActions<G extends {[N in keyof G]: N extends ModuleName<ReturnModule<G[N]>> ? G[N] : never}>(moduleGetter: G): {[key in keyof G]: ModuleActions<ReturnModule<G[key]>>} {\n  MetaData.moduleGetter = moduleGetter as any;\n  MetaData.actionCreatorMap = Object.keys(moduleGetter).reduce((maps, moduleName) => {\n    maps[moduleName] =\n      typeof Proxy === 'undefined'\n        ? {}\n        : new Proxy(\n            {},\n            {\n              get: (target: {}, key: string) => {\n                return (payload: any) => ({type: moduleName + config.NSP + key, payload});\n              },\n              set: () => {\n                return true;\n              },\n            }\n          );\n    return maps;\n  }, {});\n  return MetaData.actionCreatorMap as any;\n}\n\nexport function injectModel<MG extends ModuleGetter, N extends Extract<keyof MG, string>>(moduleGetter: MG, moduleName: N, store: ModelStore): void | Promise<void> {\n  const hasInjected = store._medux_.injectedModules[moduleName];\n  if (!hasInjected) {\n    moduleGetter = MetaData.moduleGetter as any;\n    const result = moduleGetter[moduleName]();\n    if (isPromiseModule(result)) {\n      return result.then(module => {\n        moduleGetter[moduleName] = (() => module) as any;\n        return module.default.model(store);\n      });\n    } else {\n      return result.default.model(store);\n    }\n  }\n}\n\nexport function getView<T>(moduleGetter: ModuleGetter, moduleName: string, viewName: string): T | Promise<T> {\n  moduleGetter = MetaData.moduleGetter;\n  const result = moduleGetter[moduleName]();\n  if (isPromiseModule(result)) {\n    return result.then(module => {\n      moduleGetter[moduleName] = () => module;\n      const view: T = module.default.views[viewName];\n      if (MetaData.isServer) {\n        return view;\n      }\n      const initModel = module.default.model(MetaData.clientStore);\n      if (isPromise(initModel)) {\n        return initModel.then(() => view);\n      } else {\n        return view;\n      }\n    });\n  } else {\n    const view: T = result.default.views[viewName];\n    if (MetaData.isServer) {\n      return view;\n    }\n    const initModel = result.default.model(MetaData.clientStore);\n    if (isPromise(initModel)) {\n      return initModel.then(() => view);\n    } else {\n      return view;\n    }\n  }\n}\n\nexport type LoadView = <MG extends ModuleGetter, M extends Extract<keyof MG, string>, V extends ModuleViews<ReturnModule<MG[M]>>, N extends Extract<keyof V, string>>(\n  moduleGetter: MG,\n  moduleName: M,\n  viewName: N\n) => V[N];\n\nfunction getModuleByName(moduleName: string, moduleGetter: ModuleGetter): Promise<Module> | Module {\n  const result = moduleGetter[moduleName]();\n  if (isPromiseModule(result)) {\n    return result.then(module => {\n      //在SSR时loadView不能出现异步，否则浏览器初轮渲染不会包括异步组件，从而导致和服务器返回不一致\n      moduleGetter[moduleName] = () => module;\n      return module;\n    });\n  } else {\n    return result;\n  }\n}\nfunction getModuleListByNames(moduleNames: string[], moduleGetter: ModuleGetter): Promise<Module[]> {\n  const preModules = moduleNames.map(moduleName => {\n    const module = getModuleByName(moduleName, moduleGetter);\n    if (isPromiseModule(module)) {\n      return module;\n    } else {\n      return Promise.resolve(module);\n    }\n  });\n  return Promise.all(preModules);\n}\nexport interface StoreOptions {\n  ssrInitStoreKey?: string;\n  reducers?: ReducersMapObject;\n  middlewares?: Middleware[];\n  enhancers?: StoreEnhancer[];\n  initData?: {[key: string]: any};\n  defaultRouteParams?: {[moduleName: string]: {[key: string]: any} | undefined};\n}\n\nexport function renderApp<M extends ModuleGetter, A extends Extract<keyof M, string>>(\n  render: (store: Store, appModel: Model, appViews: {[key: string]: any}, ssrInitStoreKey: string) => void,\n  moduleGetter: M,\n  appModuleName: A,\n  history: HistoryProxy,\n  storeOptions: StoreOptions = {}\n): Promise<void> {\n  MetaData.appModuleName = appModuleName;\n  const ssrInitStoreKey = storeOptions.ssrInitStoreKey || 'meduxInitStore';\n  let initData = {};\n  if (storeOptions.initData || client![ssrInitStoreKey]) {\n    initData = {...client![ssrInitStoreKey], ...storeOptions.initData};\n  }\n  const store = buildStore(history, initData, storeOptions.reducers, storeOptions.middlewares, storeOptions.enhancers, storeOptions.defaultRouteParams);\n  const preModuleNames: string[] = [appModuleName];\n  if (initData) {\n    preModuleNames.push(...Object.keys(initData).filter(key => key !== appModuleName && initData[key].isModule));\n  }\n  // 在ssr时，client必须在第一次render周期中完成和ssr一至的输出结构，所以不能出现异步模块\n  return getModuleListByNames(preModuleNames, moduleGetter).then(([appModule]) => {\n    const initModel = appModule.default.model(store);\n    render(store as any, appModule.default.model, appModule.default.views, ssrInitStoreKey);\n    return initModel;\n  });\n}\n\nexport async function renderSSR<M extends ModuleGetter, A extends Extract<keyof M, string>>(\n  render: (store: Store, appModel: Model, appViews: {[key: string]: any}, ssrInitStoreKey: string) => {html: any; data: any; ssrInitStoreKey: string},\n  moduleGetter: M,\n  appModuleName: A,\n  history: HistoryProxy,\n  storeOptions: StoreOptions = {}\n) {\n  MetaData.appModuleName = appModuleName;\n  const ssrInitStoreKey = storeOptions.ssrInitStoreKey || 'meduxInitStore';\n  const store = buildStore(history, storeOptions.initData, storeOptions.reducers, storeOptions.middlewares, storeOptions.enhancers, storeOptions.defaultRouteParams);\n  const storeState = store.getState() as StoreState;\n  const {paths} = storeState.route.data;\n  paths.length === 0 && paths.push(appModuleName);\n  let appModule: Module | undefined = undefined;\n  const inited: {[moduleName: string]: boolean} = {};\n  for (let i = 0, k = paths.length; i < k; i++) {\n    const [moduleName] = paths[i].split(config.VSP);\n    if (!inited[moduleName]) {\n      inited[moduleName] = true;\n      const module = moduleGetter[moduleName]() as Module;\n      await module.default.model(store);\n      if (i === 0) {\n        appModule = module;\n      }\n    }\n  }\n  return render(store as any, appModule!.default.model, appModule!.default.views, ssrInitStoreKey);\n}\n"],"file":"module.js"}