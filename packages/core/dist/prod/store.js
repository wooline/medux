"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=!0,exports.getActionData=getActionData,exports.buildStore=buildStore;var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_basic=require("./basic"),_actions=require("./actions"),_redux=require("redux"),_module=require("./module");function getActionData(a){var b=Object.keys(a).filter(function(a){return"type"!==a&&"priority"!==a&&"time"!==a});if(0!==b.length){if(1===b.length)return a[b[0]];var c=(0,_objectSpread2.default)({},a);return delete c.type,delete c.priority,delete c.time,c}}function bindHistory(a,b){var c=!1,d=function(d){if(!c){var e=a.getState(),f=e.route;if(f&&b.equal(f.location,d))return;var g=b.locationToRouteData(d);a.dispatch((0,_actions.routeChangeAction)({location:d,data:g}))}else c=!1};b.subscribe(d),a.subscribe(function(){if(b.initialized){var d=a.getState().route;b.equal(d.location,b.getLocation())||(c=!0,b.patch(d.location,d.data))}}),b.initialized&&d(b.getLocation())}function buildStore(a,b,c,d,e,f){if(void 0===b&&(b={}),void 0===c&&(c={}),void 0===d&&(d=[]),void 0===e&&(e=[]),void 0===f&&(f={}),c.route)throw new Error("the reducer name 'route' is not allowed");Object.assign(_basic.MetaData.defaultRouteParams,f),c.route=function(a,b){if(b.type===_actions.ActionTypes.RouteChange){var c=getActionData(b);return a?(0,_objectSpread2.default)({},a,c):c}return a};var g,h=function(a,b){if(!g)return a;var d=g._medux_;d.prevState=a;var e=(0,_objectSpread2.default)({},a);d.currentState=e,Object.keys(c).forEach(function(a){e[a]=c[a](e[a],b)});var f=d.reducerMap[b.type]||{},h=d.reducerMap[b.type.replace(new RegExp("[^"+_basic.config.NSP+"]+"),"*")]||{},i=(0,_objectSpread2.default)({},f,h),j=Object.keys(i);// 支持泛监听，形如 */loading
if(0<j.length){var k=[],l=b.priority?[].concat(b.priority):[];j.forEach(function(a){var b=i[a];a===_basic.MetaData.appModuleName?k.unshift(a):k.push(a),b.__isHandler__||l.unshift(a)}),k.unshift.apply(k,l);var n={};k.forEach(function(a){if(!n[a]){n[a]=!0;var c=i[a];e[a]=c(getActionData(b))}})}var m=Object.keys(a).length!==Object.keys(e).length||Object.keys(a).some(function(b){return a[b]!==e[b]});return d.prevState=m?e:a,d.prevState},i=_redux.applyMiddleware.apply(void 0,[function preLoadMiddleware(){return function(a){return function(b){var c=b.type.split(_basic.config.NSP),d=c[0],e=c[1];if(d&&e&&_basic.MetaData.moduleGetter[d]){var f=(0,_module.injectModel)(_basic.MetaData.moduleGetter,d,g);if((0,_basic.isPromise)(f))return f.then(function(){return a(b)})}return a(b)}}}].concat(d,[function middleware(){return function(a){return function(b){if(_basic.MetaData.isServer&&b.type.split(_basic.config.NSP)[1]===_actions.ActionTypes.MLoading)return b;var c=a(b),d=g._medux_.effectMap[c.type]||{},e=g._medux_.effectMap[c.type.replace(new RegExp("[^"+_basic.config.NSP+"]+"),"*")]||{},f=(0,_objectSpread2.default)({},d,e),h=Object.keys(f);if(0<h.length){var i=[],j=c.priority?[].concat(c.priority):[];h.forEach(function(a){var b=f[a];a===_basic.MetaData.appModuleName?i.unshift(a):i.push(a),b.__isHandler__||j.unshift(a)}),i.unshift.apply(i,j);var k={},l=[];if(i.forEach(function(a){if(!k[a]){k[a]=!0;var b=f[a],d=b(getActionData(c)),e=b.__decorators__;if(e){var h=[];e.forEach(function(b,e){h[e]=b[0](c,a,d)}),b.__decoratorResults__=h}var i=d.then(function(a){if(e){var c=b.__decoratorResults__||[];e.forEach(function(b,d){b[1]&&b[1]("Resolved",c[d],a)}),b.__decoratorResults__=void 0}return a},function(a){if(e){var d=b.__decoratorResults__||[];e.forEach(function(b,c){b[1]&&b[1]("Rejected",d[c],a)}),b.__decoratorResults__=void 0}if(c.type===_actions.ActionTypes.Error)throw void 0===(0,_basic.isProcessedError)(a)&&(a=(0,_basic.setProcessedError)(a,!0)),a;else if((0,_basic.isProcessedError)(a))throw a;else return g.dispatch((0,_actions.errorAction)(a))});l.push(i)}}),l.length)return Promise.all(l)}return c}}}])),j=[].concat(e,[i,function enhancer(a){return function(){var b=a.apply(void 0,arguments);return b._medux_={prevState:{},currentState:{},reducerMap:{},effectMap:{},injectedModules:{},currentViews:{}},b}}]);return _basic.MetaData.isDev&&_basic.client&&_basic.client.__REDUX_DEVTOOLS_EXTENSION__&&j.push(_basic.client.__REDUX_DEVTOOLS_EXTENSION__(_basic.client.__REDUX_DEVTOOLS_EXTENSION__OPTIONS)),g=(0,_redux.createStore)(h,b,_redux.compose.apply(void 0,j)),bindHistory(g,a),_basic.MetaData.clientStore=g,g}
//# sourceMappingURL=store.js.map