{"version":3,"sources":["../../src/sprite.ts"],"names":["TaskCountEvent","LoadingState","PEvent","name","data","bubbling","setTarget","target","setCurrentTarget","currentTarget","PDispatcher","parent","addListener","ename","handler","dictionary","storeHandlers","push","removeListener","Object","keys","forEach","key","handlers","propertyIsEnumerable","n","indexOf","splice","length","dispatch","evt","i","k","setParent","TaskCounter","deferSecond","addItem","promise","note","list","some","item","then","completeItem","Start","ctimer","setTimeout","Depth","findIndex","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}