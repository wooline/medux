{"version":3,"sources":["../../src/sprite.ts"],"names":["isPlainObject","obj","proto","Object","getPrototypeOf","TaskCountEvent","LoadingState","PEvent","name","data","bubbling","target","currentTarget","setTarget","setCurrentTarget","PDispatcher","parent","storeHandlers","addListener","ename","handler","dictionary","push","removeListener","keys","forEach","key","handlers","propertyIsEnumerable","n","indexOf","splice","length","dispatch","evt","i","k","setParent","TaskCounter","deferSecond","list","ctimer","addItem","promise","note","some","item","then","completeItem","Start","setTimeout","Depth","findIndex","clearTimeout","Stop"],"mappings":"iVAAA,MAAO,SAASA,CAAAA,aAAT,CAAuBC,CAAvB,CAA0C,CAC/C,GAAmB,QAAf,QAAOA,CAAAA,CAAP,EAAmC,IAAR,GAAAA,CAA/B,CAA6C,SADE,IAG/C,GAAIC,CAAAA,CAAK,CAAGD,CAHmC,CAIP,IAAjC,GAAAE,MAAM,CAACC,cAAP,CAAsBF,CAAtB,CAJwC,EAK7CA,CAAK,CAAGC,MAAM,CAACC,cAAP,CAAsBF,CAAtB,CAAR,CAGF,MAAOC,CAAAA,MAAM,CAACC,cAAP,CAAsBH,CAAtB,IAA+BC,KACvC,CAED,MAAO,IAAMG,CAAAA,cAAc,CAAG,gBAAvB,CAEP,UAAYC,CAAAA,YAAZ,C,UAAYA,C,EAAAA,C,eAAAA,C,aAAAA,C,iBAAAA,Y,GAAAA,Y,MAMZ,UAAaC,CAAAA,MAAb,yBAIE,WAAmCC,CAAnC,CAAiEC,CAAjE,CAAoFC,CAApF,CAA+G,UAA3BA,CAA2B,GAA3BA,CAA2B,kDAH/FC,MAG+F,CAHzE,IAGyE,MAF/FC,aAE+F,CAFlE,IAEoE,CAJnH,2BAMSC,SANT,CAME,mBAAiBF,CAAjB,CAAsC,CACnC,IAAD,CAAcA,MAAd,CAAuBA,CACxB,CARH,GAUSG,gBAVT,CAUE,0BAAwBH,CAAxB,CAA6C,CAC1C,IAAD,CAAcC,aAAd,CAA8BD,CAC/B,CAZH,MAeA,UAAaI,CAAAA,WAAb,yBAKE,WAAmCC,CAAnC,CAAqE,oBAJlDC,aAIkD,CAFjE,EAEmE,CALzE,2BAOSC,WAPT,CAOE,qBAAmBC,CAAnB,CAAkCC,CAAlC,CAAsE,CACpE,GAAIC,CAAAA,CAAU,CAAG,KAAKJ,aAAL,CAAmBE,CAAnB,CAAjB,CAKA,MAJKE,CAAAA,CAIL,GAHE,KAAKJ,aAAL,CAAmBE,CAAnB,EAA4BE,CAAU,CAAG,EAG3C,EADAA,CAAU,CAACC,IAAX,CAAgBF,CAAhB,CACA,CAAO,IACR,CAdH,GAgBSG,cAhBT,CAgBE,wBAAsBJ,CAAtB,CAAsCC,CAAtC,CAA2E,YACzE,GAAI,CAACD,CAAL,CACEhB,MAAM,CAACqB,IAAP,CAAY,KAAKP,aAAjB,EAAgCQ,OAAhC,CAAwC,SAAAC,CAAG,CAAI,CAC7C,MAAO,CAAA,CAAI,CAACT,aAAL,CAAmBS,CAAnB,CACR,CAFD,CADF,KAIO,CACL,GAAMC,CAAAA,CAAQ,CAAG,KAAKV,aAAtB,CACA,GAAIU,CAAQ,CAACC,oBAAT,CAA8BT,CAA9B,CAAJ,CAA0C,CACxC,GAAME,CAAAA,CAAU,CAAGM,CAAQ,CAACR,CAAD,CAA3B,CACA,GAAI,CAACC,CAAL,CACE,MAAOO,CAAAA,CAAQ,CAACR,CAAD,CADjB,KAEO,CACL,GAAMU,CAAAA,CAAC,CAAGR,CAAU,CAACS,OAAX,CAAmBV,CAAnB,CAAV,CACQ,CAAC,CAAL,CAAAS,CAFC,EAGHR,CAAU,CAACU,MAAX,CAAkBF,CAAlB,CAAqB,CAArB,CAHG,CAKqB,CAAtB,GAAAR,CAAU,CAACW,MALV,EAMH,MAAOL,CAAAA,CAAQ,CAACR,CAAD,CAElB,CACF,CACF,CACD,MAAO,KACR,CAvCH,GAyCSc,QAzCT,CAyCE,kBAAgBC,CAAhB,CAAmC,CAC5BA,CAAG,CAACvB,MADwB,EAE/BuB,CAAG,CAACrB,SAAJ,CAAc,IAAd,CAF+B,CAIjCqB,CAAG,CAACpB,gBAAJ,CAAqB,IAArB,CAJiC,CAKjC,GAAMO,CAAAA,CAAU,CAAG,KAAKJ,aAAL,CAAmBiB,CAAG,CAAC1B,IAAvB,CAAnB,CACA,GAAIa,CAAJ,CACE,IAAK,GAAIc,CAAAA,CAAC,CAAG,CAAR,CAAWC,CAAC,CAAGf,CAAU,CAACW,MAA/B,CAAuCG,CAAC,CAAGC,CAA3C,CAA8CD,CAAC,EAA/C,CACEd,CAAU,CAACc,CAAD,CAAV,CAAcD,CAAd,EAMJ,MAHI,MAAKlB,MAAL,EAAekB,CAAG,CAACxB,QAGvB,EAFE,KAAKM,MAAL,CAAYiB,QAAZ,CAAqBC,CAArB,CAEF,CAAO,IACR,CAxDH,GAyDSG,SAzDT,CAyDE,mBAAiBrB,CAAjB,CAA6C,CAE3C,MADC,KAAD,CAAcA,MAAd,CAAuBA,CACvB,CAAO,IACR,CA5DH,MA+DA,UAAasB,CAAAA,WAAb,0BAGE,WAA0BC,CAA1B,CAA+C,gBAC7C,YAD6C,yBAF/BC,IAE+B,CAFiB,EAEjB,GADvCC,MACuC,CADtB,CACsB,EAE9C,CALH,+CAMSC,OANT,CAME,iBAAeC,CAAf,CAAsCC,CAAtC,CAAuE,YAerE,gBAfoCA,CAepC,GAfoCA,CAepC,CAfmD,EAenD,EAdK,KAAKJ,IAAL,CAAUK,IAAV,CAAe,SAAAC,CAAI,QAAIA,CAAAA,CAAI,CAACH,OAAL,GAAiBA,CAArB,CAAnB,CAcL,GAbE,KAAKH,IAAL,CAAUlB,IAAV,CAAe,CAACqB,OAAO,CAAPA,CAAD,CAAUC,IAAI,CAAJA,CAAV,CAAf,CAaF,CAZED,CAAO,CAACI,IAAR,CAAa,iBAAM,CAAA,CAAI,CAACC,YAAL,CAAkBL,CAAlB,CAAN,CAAb,CAA+C,iBAAM,CAAA,CAAI,CAACK,YAAL,CAAkBL,CAAlB,CAAN,CAA/C,CAYF,CAV2B,CAArB,QAAKH,IAAL,CAAUR,MAUhB,GATI,KAAKC,QAAL,CAAc,GAAI1B,CAAAA,MAAJ,CAAWF,cAAX,CAA2BC,YAAY,CAAC2C,KAAxC,CAAd,CASJ,CARI,KAAKR,MAAL,CAAcS,UAAU,CAAC,UAAM,CAC7B,CAAI,CAACT,MAAL,CAAc,CADe,CAEN,CAAnB,CAAA,CAAI,CAACD,IAAL,CAAUR,MAFe,EAG3B,CAAI,CAACC,QAAL,CAAc,GAAI1B,CAAAA,MAAJ,CAAWF,cAAX,CAA2BC,YAAY,CAAC6C,KAAxC,CAAd,CAEH,CALuB,CAKF,GAAnB,MAAKZ,WALgB,CAQ5B,GAAOI,CACR,CAtBH,GAuBUK,YAvBV,CAuBE,sBAAqBL,CAArB,CAAkD,CAChD,GAAMR,CAAAA,CAAC,CAAG,KAAKK,IAAL,CAAUY,SAAV,CAAoB,SAAAN,CAAI,QAAIA,CAAAA,CAAI,CAACH,OAAL,GAAiBA,CAArB,CAAxB,CAAV,CAYA,MAXQ,CAAC,CAAL,CAAAR,CAWJ,GAVE,KAAKK,IAAL,CAAUT,MAAV,CAAiBI,CAAjB,CAAoB,CAApB,CAUF,CAT2B,CAArB,QAAKK,IAAL,CAAUR,MAShB,GARQ,KAAKS,MAQb,GAPMY,YAAY,CAAC,KAAKZ,MAAN,CAOlB,CANM,KAAKA,MAAL,CAAc,CAMpB,EAHI,KAAKR,QAAL,CAAc,GAAI1B,CAAAA,MAAJ,CAAWF,cAAX,CAA2BC,YAAY,CAACgD,IAAxC,CAAd,CAGJ,GAAO,IACR,CArCH,IAAiCvC,WAAjC","sourcesContent":["export function isPlainObject(obj: any): boolean {\n  if (typeof obj !== 'object' || obj === null) return false;\n\n  let proto = obj;\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\nexport const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}