{"version":3,"sources":["../../src/sprite.ts"],"names":["isPlainObject","obj","proto","Object","getPrototypeOf","TaskCountEvent","LoadingState","PEvent","name","data","bubbling","setTarget","target","setCurrentTarget","currentTarget","PDispatcher","parent","addListener","ename","handler","dictionary","storeHandlers","push","removeListener","keys","forEach","key","handlers","propertyIsEnumerable","n","indexOf","splice","length","dispatch","evt","i","k","setParent","TaskCounter","deferSecond","addItem","promise","note","list","some","item","then","completeItem","Start","ctimer","setTimeout","Depth","findIndex","clearTimeout","Stop"],"mappings":"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","sourcesContent":["export function isPlainObject(obj: any): boolean {\n  if (typeof obj !== 'object' || obj === null) return false;\n\n  let proto = obj;\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\nexport const TaskCountEvent = 'TaskCountEvent';\n\nexport enum LoadingState {\n  Start = 'Start',\n  Stop = 'Stop',\n  Depth = 'Depth',\n}\n\nexport class PEvent {\n  public readonly target: PDispatcher = null as any;\n  public readonly currentTarget: PDispatcher = null as any;\n\n  public constructor(public readonly name: string, public readonly data?: any, public bubbling: boolean = false) {}\n\n  public setTarget(target: PDispatcher) {\n    (this as any).target = target;\n  }\n\n  public setCurrentTarget(target: PDispatcher) {\n    (this as any).currentTarget = target;\n  }\n}\n\nexport class PDispatcher {\n  protected readonly storeHandlers: {\n    [key: string]: ((e: PEvent) => void)[];\n  } = {};\n\n  public constructor(public readonly parent?: PDispatcher | undefined) {}\n\n  public addListener(ename: string, handler: (e: PEvent) => void): this {\n    let dictionary = this.storeHandlers[ename];\n    if (!dictionary) {\n      this.storeHandlers[ename] = dictionary = [];\n    }\n    dictionary.push(handler);\n    return this;\n  }\n\n  public removeListener(ename?: string, handler?: (e: PEvent) => void): this {\n    if (!ename) {\n      Object.keys(this.storeHandlers).forEach(key => {\n        delete this.storeHandlers[key];\n      });\n    } else {\n      const handlers = this.storeHandlers;\n      if (handlers.propertyIsEnumerable(ename)) {\n        const dictionary = handlers[ename];\n        if (!handler) {\n          delete handlers[ename];\n        } else {\n          const n = dictionary.indexOf(handler);\n          if (n > -1) {\n            dictionary.splice(n, 1);\n          }\n          if (dictionary.length === 0) {\n            delete handlers[ename];\n          }\n        }\n      }\n    }\n    return this;\n  }\n\n  public dispatch(evt: PEvent): this {\n    if (!evt.target) {\n      evt.setTarget(this);\n    }\n    evt.setCurrentTarget(this);\n    const dictionary = this.storeHandlers[evt.name];\n    if (dictionary) {\n      for (let i = 0, k = dictionary.length; i < k; i++) {\n        dictionary[i](evt);\n      }\n    }\n    if (this.parent && evt.bubbling) {\n      this.parent.dispatch(evt);\n    }\n    return this;\n  }\n  public setParent(parent?: PDispatcher): this {\n    (this as any).parent = parent;\n    return this;\n  }\n}\n\nexport class TaskCounter extends PDispatcher {\n  public readonly list: {promise: Promise<any>; note: string}[] = [];\n  private ctimer: number = 0;\n  public constructor(public deferSecond: number) {\n    super();\n  }\n  public addItem(promise: Promise<any>, note: string = ''): Promise<any> {\n    if (!this.list.some(item => item.promise === promise)) {\n      this.list.push({promise, note});\n      promise.then(() => this.completeItem(promise), () => this.completeItem(promise));\n\n      if (this.list.length === 1) {\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Start));\n        this.ctimer = setTimeout(() => {\n          this.ctimer = 0;\n          if (this.list.length > 0) {\n            this.dispatch(new PEvent(TaskCountEvent, LoadingState.Depth));\n          }\n        }, this.deferSecond * 1000);\n      }\n    }\n    return promise;\n  }\n  private completeItem(promise: Promise<any>): this {\n    const i = this.list.findIndex(item => item.promise === promise);\n    if (i > -1) {\n      this.list.splice(i, 1);\n      if (this.list.length === 0) {\n        if (this.ctimer) {\n          clearTimeout(this.ctimer);\n          this.ctimer = 0;\n        }\n\n        this.dispatch(new PEvent(TaskCountEvent, LoadingState.Stop));\n      }\n    }\n    return this;\n  }\n}\n"],"file":"sprite.js"}